<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>कर्ज मूल्यांकन फॉर्म - अनिक फायनान्शियल सर्व्हिसेस</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0056b3; --success-color: #28a745; --danger-color: #dc3545;
            --light-bg: #f4f7f9; --dark-text: #343a40; --light-text: #6c757d;
            --border-color: #dee2e6; --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.08); --card-radius: 16px;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Poppins', 'Noto Sans Devanagari', sans-serif; background-color: var(--light-bg); margin: 0; padding: 15px; }
        .main-container { max-width: 800px; margin: 20px auto; }
        .app-header { text-align: center; margin-bottom: 30px; }
        .app-header img { max-width: 200px; margin-bottom: 10px; }
        .app-header h1 { color: var(--dark-text); font-size: 1.8rem; font-weight: 700; margin: 0; }
        .card { background-color: #ffffff; padding: 25px 30px; border-radius: var(--card-radius); box-shadow: var(--card-shadow); margin-bottom: 25px; }
        .card-header { display: flex; align-items: center; gap: 12px; color: var(--primary-color); font-size: 1.3rem; font-weight: 600; margin: -25px -30px 25px -30px; padding: 20px 30px; border-bottom: 1px solid #e9ecef; }
        .form-section { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .form-section { grid-template-columns: 1fr 1fr; } .full-width { grid-column: 1 / -1; } }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 8px; font-weight: 500; color: var(--dark-text); font-size: 0.95em; }
        .input-group input, .input-group select, .input-group textarea { padding: 14px 16px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1em; font-family: inherit; transition: all 0.2s ease; background: #fdfdfd; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1); }
        textarea { resize: vertical; min-height: 80px; }
        #camera-container { border: 2px dashed var(--border-color); margin-bottom: 15px; background-color: #000; border-radius: 12px; overflow: hidden; }
        video { display: block; width: 100%; height: auto; }
        button { background-color: var(--primary-color); color: white; padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 600; font-family: inherit; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 86, 179, 0.2); }
        button:disabled { background-color: #9db2bf; cursor: not-allowed; }
        #submit-form { background-color: var(--success-color); width: 100%; font-size: 1.2rem; padding: 18px; }
        #photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .thumbnail-container { position: relative; }
        .thumbnail { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .delete-btn { position: absolute; top: 0px; right: 0px; background: var(--danger-color); color: white; border: 2px solid white; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; line-height: 26px; text-align: center; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status-message { text-align: center; margin-top: 20px; font-weight: 500; padding: 15px; border-radius: 10px; display: none; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        #print-area { display: none; }
        
        /* Initial Selection Styles */
        #initial-selection { text-align: center; padding: 50px 20px; }
        #initial-selection button { width: 80%; max-width: 300px; margin: 15px; padding: 20px; font-size: 1.1rem; }
        #update-form-fields { background-color: #e6f0ff; padding: 20px; border-radius: var(--card-radius); margin-top: 20px; border: 1px solid var(--primary-color); display: none; }

        /* Print Styles */
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body > *:not(#print-area) { display: none; }
            #print-area { display: block; font-family: 'Noto Sans Devanagari', sans-serif; }
            @page { size: A4; margin: 0; }
            .print-page { padding: 1.5cm; height: 297mm; width: 210mm; position: relative; page-break-after: always; }
            .print-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 6rem; color: rgba(0, 0, 0, 0.06); font-weight: 700; z-index: 1; pointer-events: none; }
            .print-content { position: relative; z-index: 2; }
            .print-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; margin-bottom: 20px; }
            .print-header img { width: 150px; }
            .print-header h1 { font-size: 1.8rem; color: var(--primary-color); text-align: right; font-weight: 700; margin: 0; }
            .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px; }
            .section-title { font-size: 1.2rem; color: var(--dark-text); margin: 20px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 8px; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            .print-table td { padding: 8px; border: 1px solid #e0e0e0; vertical-align: top; word-break: break-word; }
            .print-table td:first-child { font-weight: 600; width: 40%; background-color: #f9f9f9; }
            .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; page-break-inside: avoid; }
            .print-photo-container { text-align: center; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
            .print-photo-container img { max-width: 100%; border-radius: 8px; height: 200px; object-fit: cover; }
            .map-container { margin-top: 25px; page-break-inside: avoid; text-align: center; }
            .map-container img { max-width: 100%; border: 1px solid #ddd; border-radius: 12px; }
            .print-footer { position: absolute; bottom: 1cm; left: 1.5cm; right: 1.5cm; text-align: center; font-size: 0.8rem; color: #888; border-top: 1px solid #eee; padding-top: 8px; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="app-header"><img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" alt="Company Logo"><h1>कर्ज मूल्यांकन फॉर्म</h1></div>

        <!-- Initial Selection Screen -->
        <div class="card" id="initial-selection">
            <h2>कृपया तुमचा पर्याय निवडा</h2>
            <button type="button" onclick="setMode('new')" style="background-color: var(--primary-color);">
                <i class="fas fa-file-alt"></i> नवीन फॉर्म भरा
            </button>
            <button type="button" onclick="setMode('update')" style="background-color: #ff9900;">
                <i class="fas fa-edit"></i> जुना फॉर्म अपडेट करा
            </button>
            
            <div id="update-form-fields">
                <div class="form-section">
                    <div class="input-group">
                        <label for="updateFieldOfficerName">क्षेत्र अधिकारीचे नाव</label>
                        <select id="updateFieldOfficerName" onchange="fetchCustomerList(this.value)"><option value="">निवडा</option></select>
                    </div>
                    <div class="input-group">
                        <label for="updateCustomerName">ग्राहकाचे नांव निवडा</label>
                        <select id="updateCustomerName" onchange="loadExistingForm(this.value)" disabled><option value="">क्षेत्र अधिकारी निवडा</option></select>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Initial Selection Screen -->

        <!-- Main Form Area -->
        <form id="loanAppraisalForm" style="display: none;">
            <div id="dynamic-form-container"></div>
            <div class="card">
                <h3 class="card-header"><i class="fas fa-camera-retro"></i>GPS फोटो आणि लोकेशन</h3>
                <div id="camera-container"><video id="video" autoplay playsinline></video></div>
                <div class="controls"><button type="button" id="capture-button"><i class="fas fa-camera"></i>फोटो ॲड करा</button></div>
                <div id="photo-gallery-card" style="display: none;"><h4 style="margin-top:20px;border-bottom:1px solid var(--border-color);padding-bottom:10px;">काढलेले फोटो</h4><div id="photo-gallery"></div></div>
            </div>
            <div class="card"><button type="submit" id="submit-form"><i class="fas fa-paper-plane"></i>फॉर्म सबमिट करा</button></div>
        </form>
        <!-- End Main Form Area -->

        <div id="status-message"></div>
    </div>
    <div id="watermark-overlay" style="position: absolute; left: -9999px;"></div>
    <canvas id="hidden-canvas" style="display:none;"></canvas>
    <div id="print-area"></div>

    <script>
        // ***** येथे तुमची Apps Script URL टाका *****
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrCZKKUyxTVGOFGXzK755pFnlAjjK4WFbTNwfx0ubm8myqIuYdcTNoQh0XX4OUgg/exec'; // REPLACE ME

        // ########## FORM CONFIGURATION ##########
        const formConfig = [
            {
                title: "मूलभूत माहिती (Basic KYC Details)", icon: "fa-user-check",
                fields: [
                    { id: "customerName", label: "नाव", type: "text", required: true }, { id: "applicantAge", label: "वय", type: "number",required: true }, { id: "applicantGender", label: "लिंग", type: "select", options: ["निवडा", "पुरुष", "स्त्री", "इतर"] }, { id: "villageName", label: "गावाचे नांव", type: "text", required: true }, { id: "taluka", label: "तालुका", type: "select", options: ["निवडा", "कळंब", "भुम", "वाशी", "परांडा"] }, { id: "district", label: "जिल्हा", type: "text", value: "धाराशिव", disabled: true }, { id: "coApplicantName", label: "सहकर्जदार/पती/पत्नीचे नाव", type: "text",required: true }, { id: "coApplicantAadhaar", label: "सहकर्जदार आधार नंबर", type: "number",required: true }, { id: "coApplicantPan", label: "सहकर्जदार पॅन नंबर", type: "text",required: true }, { id: "mobileNumber", label: "मोबाईल क्रमांक", type: "tel", required: true }, { id: "aadhaarNumber", label: "आधार क्रमांक", type: "number",required: true }, { id: "panNumber", label: "पॅन क्रमांक", type: "text" }, { id: "isExistingCustomer", label: "सध्या अनिकचे ग्राहक आहात?", type: "select", options: ["निवडा", "होय", "नाही"] }, { id: "existingAccountNumber", label: "सध्याचा खाते क्रमांक", type: "text" }, { id: "branchName", label: "शाखेचे नाव", type: "select", options: ["निवडा", "कळंब", "भुम", "वाशी"] }, { id: "maritalStatus", label: "वैवाहिक स्थिती", type: "select", options: ["निवडा", "विवाहित", "अविवाहित", "विधवा/विधुर"] }, { id: "educationLevel", label: "शिक्षण", type: "select", options: ["निवडा", "शिक्षण नाही", "प्राथमिक", "माध्यमिक", "पदवीधर"] }, { id: "centerName", label: "केंद्राचे नाव/कोड", type: "text" },
                ]
            },
            {
                title: "कुटुंबाची माहिती (Family Details)", icon: "fa-users",
                fields: [
                    { id: "familyTotalMembers", label: "घरातील एकूण सदस्य", type: "number",required: true }, { id: "familyEarningMembers", label: "कमावणारे सदस्य", type: "number",required: true }, { id: "familyTotalIncome", label: "एकूण मासिक उत्पन्न (रु)", type: "number",required: true }, { id: "expenseHousehold", label: "घरखर्च (रु)", type: "number",required: true }, { id: "expenseEducation", label: "शिक्षण खर्च (रु)", type: "number",required: true }, { id: "expenseMedical", label: "वैद्यकीय खर्च (रु)", type: "number",required: true }, { id: "expenseOther", label: "इतर खर्च (रु)", type: "number",required: true }, { id: "expenseTotal", label: "एकूण मासिक खर्च (रु)", type: "number", disabled: true }
                ]
            },
            {
                title: "उत्पन्न स्रोत (Income Source)", icon: "fa-hand-holding-dollar",
                fields: [ { id: "primaryIncomeSource", label: "प्राथमिक उत्पन्न स्रोत", type: "select", options: ["निवडा", "शेती", "पशुधन", "छोटा व्यवसाय", "मजुरी", "सेवा क्षेत्र", "इतर"] }, { id: "primaryIncomeAmount", label: "मासिक उत्पन्न (रु)", type: "number" }
, { id: "secondaryIncomeSource", label: "दुय्यम उत्पन्न स्रोत", type: "select", options: ["निवडा", "शेती", "पशुधन", "छोटा व्यवसाय", "मजुरी", "सेवा क्षेत्र", "इतर"] }, { id: "secondaryIncomeAmount", label: "दुय्यम मासिक उत्पन्न (रु)", type: "number" } ]
            },
            {
                title: "मालमत्ता माहिती (Assets Details)", icon: "fa-house-chimney",
                fields: [ { id: "assetLandAcres", label: "जमीन (एकर)", type: "number",required: true }, { id: "assetLandType", label: "जमीनीचा प्रकार", type: "select", options: ["निवडा", "बागायती", "जिरायत"] }, { id: "assetHouseType", label: "घराचा प्रकार", type: "select", options: ["निवडा", "प्लास्टर केलेले", "विटांचे", "मातीचे", "भाड्याचे"] }, { id: "assetPlots", label: "प्लॉट्स/Shopes", type: "select", options: ["निवडा", "आहेत", "नाहीत"] }, { id: "assetEquipmentFarm", label: "शेतीसाठीची उपकरणे", type: "text" }, { id: "assetEquipmentBusiness", label: "व्यवसायासाठीची उपकरणे", type: "text" }, { id: "assetVehicle", label: "वाहन", type: "text", placeholder: "उदा. दुचाकी, ट्रॅक्टर" } ]
            },
            {
                title: "पशुधन माहिती (Livestock Details)", icon: "fa-cow",
                fields: [ { id: "cows", label: "गायी", type: "number",required: true }, { id: "buffaloes", label: "म्हशी", type: "number",required: true}, { id: "goats", label: "बकऱ्या/मेंढ्या", type: "number",required: true }, { id: "poultry", label: "कोंबड्या", type: "number",required: true }, { id: "pigs", label: "वराह पालन", type: "number" }, { id: "bulls", label: "बैलजोडी", type: "number" }, { id: "otherLivestock", label: "इतर", type: "number" }, ]
            },

            {
                title: "दुग्धउत्पादन ", icon: "fa-cow",
                fields: [ { id: "milkincome", label: "दुग्धउत्पादन किती होते (लिटर मध्ये उल्लेख करा)", type: "number",required: true }, ]
            },

            {
                title: "बचत व गुंतवणूक (Savings & Investment)", icon: "fa-piggy-bank",
                fields: [ { id: "savingsBankAccount", label: "बँक खाते क्रमांक", type: "text" }, { id: "savingsPigmy", label: "पिग्मी खाते", type: "select", options: ["निवडा", "आहे", "नाही"] }, { id: "savingsInsurancePolicy", label: "विमा पॉलिसी", type: "select", options: ["निवडा", "आहे", "नाही"] }, { id: "savingsInsuranceType", label: "विमा प्रकार", type: "select", options: ["लागू नाही", "जीवन", "आरोग्य", "अपघात", "Crop"] }, { id: "savingsOther", label: "इतर बचत/गुंतवणूक", type: "text", fullWidth:true } ]
            },
            {
                title: "कर्ज संबंधित माहिती (Loan Details)", icon: "fa-file-invoice-dollar",
                fields: [ { id: "loanAmountRequested", label: "मागितलेली रक्कम (रु)", type: "number", required: true }, { id: "loanProductType", label: "कर्ज प्रकार", type: "select", options: ["निवडा", "शेती", "व्यवसाय", "पशुधन", "वैयक्तिक", "घर दुरुस्ती"] }, { id: "loanCycle", label: "कर्ज सायकल (कितवे कर्ज?)", type: "number" }, { id: "loanPurpose", label: "कर्जाचा उद्देश", type: "textarea", fullWidth:true }, { id: "previousLoanSource", label: "यापूर्वी कुठून कर्ज घेतले?", type: "select", options: ["Anik Financial", "Bank", "Other Finance Company", "Personal", "नातेवाईक", "सावकार"] }, { id: "previousLoanDetails", label: "मागील कर्ज तपशील (बाकी रक्कम)", type: "text" }, { id: "repaymentPeriod", label: "परतफेड कालावधी (महिने)", type: "number" }, { id: "existingEMI", label: "इतर कर्जाचा चालू EMI", type: "number" }, { id: "guarantorDetails", label: "हमीदाराची माहिती", type: "text", fullWidth: true } ]
            },
            {
                title: "सहायक कागदपत्रे अपलोड (Supporting Documents)", icon: "fa-upload",
                fields: [ 
                    { 
                        id: "supportingDocuments", 
                        label: "कागदपत्रे निवडा (PDF, फोटो, एकापेक्षा जास्त)", 
                        type: "file", 
                        multiple: true, 
                        accept: "image/*,application/pdf", 
                        fullWidth: true 
                    } 
                ]
            },
            {
                title: "अधिकारी निरीक्षण", icon: "fa-circle-info",
                fields: [ { id: "visitDate", label: "भेट दिनांक", type: "date", required: true }, { id: "fieldOfficerName", label: "क्षेत्र अधिकारीचे नाव", type: "select", options: ["लोड होत आहे..."], required: true }, { id: "remarks", label: "निरीक्षण / टिपण", type: "textarea", fullWidth: true } ]
            }
        ];


        // ########## SCRIPT LOGIC ##########
        let lastSubmittedData = null;
        let formMode = 'new'; // 'new' or 'update'
        let currentUpdateRow = null; // Stores the row index to update
        let existingPhotoLinks = []; // Stores existing photo links when updating
        let existingDocLinks = []; // Stores existing doc links when updating

        const formContainer = document.getElementById('dynamic-form-container');
        const elements = { video: document.getElementById('video'), captureButton: document.getElementById('capture-button'), photoGallery: document.getElementById('photo-gallery'), watermarkOverlay: document.getElementById('watermark-overlay'), hiddenCanvas: document.getElementById('hidden-canvas'), photoGalleryCard: document.getElementById('photo-gallery-card'), form: document.getElementById('loanAppraisalForm'), submitButton: document.getElementById('submit-form'), statusMessage: document.getElementById('status-message'), printArea: document.getElementById('print-area'), initialSelection: document.getElementById('initial-selection'), updateFieldsContainer: document.getElementById('update-form-fields'), updateOfficerSelect: document.getElementById('updateFieldOfficerName'), updateCustomerSelect: document.getElementById('updateCustomerName') };
        
        let currentLocationData = null;
        let capturedPhotos = []; // New photos taken in the current session

        function setMode(mode) {
            formMode = mode;
            elements.initialSelection.style.display = 'none';
            elements.form.style.display = 'block';

            if (mode === 'update') {
                elements.initialSelection.style.display = 'block';
                elements.updateFieldsContainer.style.display = 'block';
                elements.form.style.display = 'none';
                elements.submitButton.innerHTML = `<i class="fas fa-save"></i> जुना फॉर्म अपडेट करा`;
                // Load officer list into the update selector as well
                fetchStaffNames(elements.updateOfficerSelect.id); 
            } else {
                elements.form.reset();
                capturedPhotos = [];
                currentUpdateRow = null;
                updatePhotoGallery();
                document.getElementById('visitDate').valueAsDate = new Date();
                elements.submitButton.innerHTML = `<i class="fas fa-paper-plane"></i>फॉर्म सबमिट करा`;
            }
            window.scrollTo(0, 0);
        }

        function generateForm() { 
            formConfig.forEach(section => { 
                let fieldsHTML = ''; 
                section.fields.forEach(field => { 
                    const requiredAttr = field.required ? 'required' : ''; 
                    let fieldHTML = `<div class="input-group ${field.fullWidth ? 'full-width' : ''}"><label for="${field.id}">${field.label} ${field.required ? '<span style="color:red;">*</span>' : ''}</label>`; 
                    
                    if (field.type === 'select') { 
                        fieldHTML += `<select id="${field.id}" name="${field.id}" ${requiredAttr}>`; 
                        field.options.forEach(opt => fieldHTML += `<option value="${(opt === 'निवडा' || opt === 'लागू नाही') ? '' : opt}">${opt}</option>`); 
                        fieldHTML += `</select>`; 
                    } else if (field.type === 'textarea') { 
                        fieldHTML += `<textarea id="${field.id}" name="${field.id}" placeholder="${field.placeholder || ''}" ${requiredAttr}></textarea>`; 
                    } else if (field.type === 'file') {
                        const multipleAttr = field.multiple ? 'multiple' : '';
                        const acceptAttr = field.accept ? `accept="${field.accept}"` : '';
                        fieldHTML += `<input type="file" id="${field.id}" ${requiredAttr} ${multipleAttr} ${acceptAttr}>`;
                        fieldHTML += `<p style="font-size: 0.8em; color: #888; margin-top: 5px;">मोठी फाईल (उदा. मोठी PDF) अपलोड केल्यास सबमिशनला वेळ लागू शकतो.</p>`;
                    } else { 
                        const disabledAttr = field.disabled ? 'disabled' : ''; 
                        const valueAttr = field.value ? `value="${field.value}"` : ''; 
                        fieldHTML += `<input type="${field.type}" id="${field.id}" name="${field.id}" ${requiredAttr} ${disabledAttr} ${valueAttr} placeholder="${field.placeholder || ''}">`; 
                    } 
                    fieldHTML += `</div>`; 
                    fieldsHTML += fieldHTML; 
                }); 
                const sectionHTML = `<div class="card"><h3 class="card-header"><i class="fas ${section.icon}"></i>${section.title}</h3><div class="form-section">${fieldsHTML}</div></div>`; 
                formContainer.innerHTML += sectionHTML; 
            }); 
            document.getElementById('visitDate').valueAsDate = new Date(); 
        }

        async function fetchStaffNames(selectId = 'fieldOfficerName') { 
            try { 
                const response = await fetch(`${SCRIPT_URL}?action=getStaff`); 
                if (!response.ok) throw new Error("Network response error."); 
                const result = await response.json(); 
                
                const staffSelects = document.querySelectorAll(`#${selectId}, #fieldOfficerName`);
                
                if (result.status === 'success' && result.data.length > 0) { 
                    staffSelects.forEach(staffSelect => {
                        const currentVal = staffSelect.value;
                        staffSelect.innerHTML = '<option value="">निवडा</option>'; 
                        result.data.forEach(name => { staffSelect.innerHTML += `<option value="${name}">${name}</option>`; });
                        if(currentVal) staffSelect.value = currentVal;
                    });
                } else { 
                    throw new Error(result.message || "Staff data not found."); 
                } 
            } catch (error) { 
                console.error('Error fetching staff names:', error); 
                document.getElementById(selectId).innerHTML = '<option value="">नावे लोड होऊ शकली नाहीत</option>'; 
                document.getElementById('fieldOfficerName').innerHTML = '<option value="">नावे लोड होऊ शकली नाहीत</option>'; 
            } 
        }

        async function fetchCustomerList(officerName) {
            elements.updateCustomerSelect.innerHTML = '<option value="">लोड होत आहे...</option>';
            elements.updateCustomerSelect.disabled = true;

            if (!officerName) {
                elements.updateCustomerSelect.innerHTML = '<option value="">क्षेत्र अधिकारी निवडा</option>';
                return;
            }

            try {
                const url = `${SCRIPT_URL}?action=getCustomersByOfficer&officer=${encodeURIComponent(officerName)}`;
                const response = await fetch(url);
                const result = await response.json();

                elements.updateCustomerSelect.innerHTML = '<option value="">ग्राहकाचे नांव निवडा</option>';
                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(customer => {
                        // value is the row number, text is the customer name
                        elements.updateCustomerSelect.innerHTML += `<option value="${customer.rowId}">${customer.customerName} (${customer.rowId})</option>`;
                    });
                } else {
                    elements.updateCustomerSelect.innerHTML = '<option value="">ग्राहक आढळले नाही</option>';
                }
            } catch (error) {
                console.error("Error fetching customer list:", error);
                elements.updateCustomerSelect.innerHTML = '<option value="">त्रुटी (Error)</option>';
            } finally {
                elements.updateCustomerSelect.disabled = false;
            }
        }

        async function loadExistingForm(rowId) {
            if (!rowId) {
                elements.form.style.display = 'none';
                currentUpdateRow = null;
                return;
            }

            elements.initialSelection.style.display = 'none';
            elements.form.style.display = 'block';
            currentUpdateRow = rowId;
            capturedPhotos = []; // Clear current session photos
            existingPhotoLinks = []; // Reset existing links
            existingDocLinks = []; // Reset existing doc links
            elements.form.reset();
            updatePhotoGallery();

            elements.submitButton.innerHTML = '<div class="spinner"></div> डेटा लोड करत आहे...';
            elements.submitButton.disabled = true;

            try {
                const url = `${SCRIPT_URL}?action=loadRow&row=${rowId}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    const data = result.data;
                    
                    // 1. Populate standard fields
                    for (const key in data) {
                        const input = document.getElementById(key);
                        if (input) {
                            if (input.type === 'date' && data[key]) {
                                // For date inputs, set value directly
                                input.value = data[key]; 
                            } else {
                                input.value = data[key];
                            }
                        }
                    }

                    // 2. Handle existing GPS Photo Links
                    if (data.photoLinks) {
                        existingPhotoLinks = data.photoLinks.split('\n').filter(link => link.trim() !== '');
                        // We don't display existing photos, but save the links to be re-submitted.
                    }
                    
                    // 3. Handle existing Supporting Document Links
                    if (data.supportdoc) {
                        existingDocLinks = data.supportdoc.split('\n').filter(link => link.trim() !== '');
                        alert(`टीप: या अर्जात पूर्वीच ${existingDocLinks.length} सहायक कागदपत्रे जोडलेली आहेत. तुम्ही नवीन फाईल्स जोडल्यास, त्या जुन्या फाईल्ससोबत सबमिट होतील.`);
                    }

                    alert(`फॉर्म #${rowId} (ग्राहक: ${data.customerName}) लोड झाला आहे. तुम्ही बदल करू शकता आणि सबमिट करू शकता.`);

                } else {
                    throw new Error(result.message || 'डेटा लोड होऊ शकला नाही.');
                }
            } catch (error) {
                console.error("Load Error:", error);
                alert(`डेटा लोड करताना त्रुटी आली: ${error.message}`);
                setMode('update'); // Go back to selection mode
            } finally {
                elements.submitButton.innerHTML = `<i class="fas fa-save"></i> जुना फॉर्म अपडेट करा`;
                elements.submitButton.disabled = false;
            }
        }


        function initializeGeolocation() { 
            if (navigator.geolocation) { 
                navigator.geolocation.watchPosition( (position) => { 
                    const { latitude, longitude } = position.coords; 
                    if (currentLocationData && Math.abs(currentLocationData.lat - latitude) < 0.0001 && Math.abs(currentLocationData.lon - longitude) < 0.0001) return; 
                    currentLocationData = { lat: latitude, lon: longitude, address: "पत्ता लोड होत आहे..." }; 
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`).then(res => res.json()).then(data => { currentLocationData.address = data.display_name || "पत्ता उपलब्ध नाही"; }).catch(() => { currentLocationData.address = "पत्ता मिळवता आला नाही"; }); 
                }, (error) => { 
                    console.error("GPS Error:", error); 
                    // alert("GPS सिग्नल मिळत नाहीये. कृपया लोकेशन सेटिंग तपासा."); 
                }, { enableHighAccuracy: true }); 
            } else { 
                alert("तुमच्या ब्राउझरमध्ये GPS सपोर्ट नाही."); 
            } 
        }
        function updatePhotoGallery() { elements.photoGalleryCard.style.display = capturedPhotos.length > 0 ? 'block' : 'none'; elements.photoGallery.innerHTML = ''; capturedPhotos.forEach((photo, index) => { const container = document.createElement('div'); container.className = 'thumbnail-container'; const img = document.createElement('img'); img.src = photo; img.className = 'thumbnail'; const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.innerHTML = '&times;'; deleteBtn.className = 'delete-btn'; deleteBtn.onclick = () => { capturedPhotos.splice(index, 1); updatePhotoGallery(); }; container.append(img, deleteBtn); elements.photoGallery.appendChild(container); }); }
        async function createWatermarkedImage(canvas) { const now = new Date(); const dateTime = `${now.toLocaleDateString('en-GB')} ${now.toLocaleTimeString('en-US', { hour12: true })}`; elements.watermarkOverlay.innerHTML = `<p style="margin: 4px 0; font-size: 10px; font-weight: 300;">${currentLocationData.address}</p><p style="margin: 4px 0; font-size: 10px;"><b>Coords:</b> ${currentLocationData.lat.toFixed(6)}, ${currentLocationData.lon.toFixed(6)}</p><p style="margin: 4px 0; font-size: 10px;"><b>वेळ:</b> ${dateTime}</p>`; elements.watermarkOverlay.style.cssText = `position: absolute; left: -9999px; width: 500px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 12px; font-family: 'Poppins', Arial, sans-serif; border-radius: 6px; text-shadow: 2px 2px 4px #000;`; const watermarkCanvas = await html2canvas(elements.watermarkOverlay, { backgroundColor: null, scale: 3 }); const context = canvas.getContext('2d'); const margin = canvas.width * 0.02, drawWidth = canvas.width * 0.96; const drawHeight = watermarkCanvas.height * (drawWidth / watermarkCanvas.width); context.drawImage(watermarkCanvas, margin, canvas.height - drawHeight - margin, drawWidth, drawHeight); return canvas.toDataURL('image/jpeg', 0.8); }
        async function handleCaptureClick() { if (!currentLocationData || !currentLocationData.lat) { alert("लोकेशनची माहिती मिळत आहे, कृपया थांबा."); return; } const button = elements.captureButton; const originalHTML = button.innerHTML; button.innerHTML = '<div class="spinner"></div> कॅप्चर करत आहे...'; button.disabled = true; try { const canvas = elements.hiddenCanvas; canvas.width = elements.video.videoWidth; canvas.height = elements.video.videoHeight; canvas.getContext('2d').drawImage(elements.video, 0, 0, canvas.width, canvas.height); const watermarkedImageDataUrl = await createWatermarkedImage(canvas); capturedPhotos.push(watermarkedImageDataUrl); updatePhotoGallery(); } catch (error) { console.error("Error capturing:", error); alert("फोटो काढताना त्रुटी आली."); } finally { button.innerHTML = originalHTML; button.disabled = false; } }
        
        function readAllFiles(files) {
            const promises = [];
            for (let i = 0; i < files.length; i++) {
                promises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        resolve({
                            fileName: files[i].name,
                            dataUrl: event.target.result
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(files[i]);
                }));
            }
            return Promise.all(promises);
        }

        async function handleSubmit(e) { 
            e.preventDefault(); 
            if (!elements.form.checkValidity()) { 
                alert('कृपया सर्व आवश्यक (*) फील्ड भरा.'); 
                return; 
            } 
            
            const originalButtonHTML = elements.submitButton.innerHTML; 
            elements.submitButton.innerHTML = '<div class="spinner"></div> डेटा अनिक मुख्यालयाकडे जमा होतो आहे कृपया थांबा याकरीता 1 मिनीटांपर्यंत वेळ लागु शकतो...'; 
            elements.submitButton.disabled = true; 
            elements.statusMessage.style.display = 'none'; 

            // 1. फाईल इनपुटमधून डेटा वाचा
            const fileInput = document.getElementById('supportingDocuments');
            let fileDataUrls = [];
            
            if (fileInput.files.length > 0) {
                try {
                    fileDataUrls = await readAllFiles(fileInput.files);
                } catch (error) {
                    console.error("Error reading supporting files:", error);
                    alert("कागदपत्रे वाचताना त्रुटी आली. कृपया पुन्हा प्रयत्न करा.");
                    elements.submitButton.innerHTML = originalButtonHTML;
                    elements.submitButton.disabled = false;
                    return;
                }
            }


            // 2. इतर फॉर्म डेटा गोळा करा
            const formData = new FormData(elements.form);
            const data = Object.fromEntries(formData.entries());
            
            // Set action and row index for update mode
            if (formMode === 'update' && currentUpdateRow) {
                data.action = 'updateRow';
                data.row = currentUpdateRow;
            } else {
                data.action = 'newSubmission';
            }

            // ***** नवीन लॉजिक: dd/mm/yyyy स्वरूपनात तारीख जोडणे *****
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            data.actualTime = `${day}/${month}/${year}`; 
            // *******************************************************

            // 3. फोटो आणि सपोर्टिंग डॉक्युमेंट डेटा जोडा
            // capturedPhotos = new photos taken now
            // existingPhotoLinks = photos already linked to this record (in update mode)
            data.photos = existingPhotoLinks.concat(capturedPhotos);
            data.supportdoc = existingDocLinks.concat(fileDataUrls);

            data.gpsLatitude = currentLocationData?.lat || ''; 
            data.gpsLongitude = currentLocationData?.lon || ''; 
            data.gpsAddress = currentLocationData?.address || ''; 
            lastSubmittedData = data; 

            try { 
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) }); 
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`); 
                const result = await response.json(); 
                
                if (result.status === 'success') { 
                    elements.statusMessage.className = 'status-success'; 
                    elements.statusMessage.innerHTML = `${formMode === 'update' ? 'फॉर्म यशस्वीरित्या अपडेट झाला' : 'फॉर्म यशस्वीरित्या सबमिट झाला'}! <br><br> <button type="button" onclick="printReport()">रिपोर्ट प्रिंट करा</button>`; 
                    
                    // Reset or prepare for next action
                    elements.form.reset(); 
                    capturedPhotos = []; 
                    existingPhotoLinks = [];
                    existingDocLinks = [];
                    currentUpdateRow = null;
                    updatePhotoGallery(); 
                    document.getElementById('visitDate').valueAsDate = new Date(); 
                    document.querySelector('[name="district"]').value = "धाराशिव"; 

                    // Show selection screen again after successful operation
                    elements.form.style.display = 'none';
                    elements.initialSelection.style.display = 'block';

                } else { 
                    throw new Error(result.message); 
                } 
            } catch (error) { 
                elements.statusMessage.className = 'status-error'; 
                elements.statusMessage.innerHTML = `एक त्रुटी आली: ${error.message}. सबमिशन अयशस्वी.`; 
                lastSubmittedData = null; 
            } finally { 
                elements.statusMessage.style.display = 'block'; 
                elements.submitButton.innerHTML = originalButtonHTML; 
                elements.submitButton.disabled = false; 
                window.scrollTo(0, document.body.scrollHeight); 
            } 
        }
        
        // ===================================
        // ===== PRINT FUNCTION STARTS =====
        // ===================================
        function generatePrintHTML(data) {
            // ... (Same as previous print function logic) ...
            const logoUrl = "https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png";
            const mapImageUrl = (data.gpsLatitude && data.gpsLongitude) ? `https://static-maps.yandex.ru/1.x/?ll=${data.gpsLongitude},${data.gpsLatitude}&z=17&l=sat,skl&size=650,450&pt=${data.gpsLongitude},${data.gpsLongitude},pm2rdl` : '';
            const gmapLink = (data.gpsLatitude && data.gpsLongitude) ? `https://www.google.com/maps?q=${data.gpsLatitude},${data.gpsLongitude}` : '';
            
            let detailsHTML = `<div class="print-page"><div class="print-watermark">अनिक फायनान्स</div><div class="print-content"><div class="print-header"><img src="${logoUrl}" alt="Company Logo"><h1>GPS व्हेरिफिकेशन<br>अहवाल</h1></div>`;
            detailsHTML += `<h3 class="section-title">मूलभूत माहिती</h3><table class="print-table"><tr><td>ग्राहकाचे नाव</td><td>${data.customerName||''}</td></tr><tr><td>गाव</td><td>${data.villageName||''}</td></tr><tr><td>कर्जाची रक्कम</td><td>रु ${data.loanAmountRequested||''}</td></tr><tr><td>क्षेत्र अधिकारी</td><td>${data.fieldOfficerName||''}</td></tr></table>`;
            
            formConfig.forEach(section => {
                if (section.title.includes('अपलोड')) return; 

                let sectionHasData = section.fields.some(field => data[field.id] && data[field.id].toString().trim() !== '');
                if(sectionHasData){
                    detailsHTML += `<h3 class="section-title">${section.title}</h3><table class="print-table">`;
                    section.fields.forEach(field => { 
                        if (field.id !== 'supportingDocuments' && data[field.id] && data[field.id].toString().trim() !== '' && (!field.value || data[field.id] !== field.value)) { 
                            detailsHTML += `<tr><td>${field.label}</td><td>${data[field.id]}</td></tr>`; 
                        } 
                    });
                    detailsHTML += `</table>`;
                }
            });

            // Handle combined photo links (existing + new captured) for printing
            const allPhotoLinks = Array.isArray(data.photos) ? data.photos.filter(link => link.startsWith('data:')) : data.photoLinks ? data.photoLinks.split('\n').filter(link => link.trim() !== '') : [];


            if (allPhotoLinks && allPhotoLinks.length > 0) {
                detailsHTML += `<h3 class="section-title">काढलेले छायाचित्र</h3><div class="photo-grid">`;
                allPhotoLinks.forEach(photoDataUrl => {
                    detailsHTML += `<div class="print-photo-container"><img src="${photoDataUrl}"></div>`;
                });
                detailsHTML += `</div>`;
            }

            if (mapImageUrl) { 
                detailsHTML += `<div class="map-container"><h3 class="section-title">GPS लोकेशन नकाशा</h3><img src="${mapImageUrl}" class="print-map"><p style="font-size:10pt; margin-top:8px;"><strong>Google Maps Link:</strong> <a href="${gmapLink}" target="_blank">${gmapLink}</a></p></div>`; 
            }
            
            detailsHTML += `<div class="print-footer">हा रिपोर्ट ${new Date().toLocaleString('mr-IN')} रोजी स्वयंचलितपणे तयार झाला आहे.</div></div></div>`;
            return detailsHTML;
        }

        function printReport() {
            if (lastSubmittedData) {
                elements.printArea.innerHTML = generatePrintHTML(lastSubmittedData);

                const images = elements.printArea.querySelectorAll('img');
                const promises = [];

                images.forEach(img => {
                    promises.push(new Promise((resolve) => {
                        if (img.complete) {
                            resolve();
                        } else {
                            img.onload = resolve;
                            img.onerror = resolve; 
                        }
                    }));
                });

                Promise.all(promises).then(() => {
                    window.print();
                });

            } else {
                alert("प्रिंट करण्यासाठी डेटा उपलब्ध नाही.");
            }
        }
        // ===================================
        // =====  PRINT FUNCTION ENDS  =====
        // ===================================

        window.addEventListener('load', async () => { 
            generateForm(); 
            // Only load officer list into the update selection initially
            fetchStaffNames('updateFieldOfficerName'); 

            try { 
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); 
                elements.video.srcObject = stream; 
                initializeGeolocation(); 
                elements.captureButton.addEventListener('click', handleCaptureClick); 
                elements.form.addEventListener('submit', handleSubmit); 
            } catch (err) { 
                alert("ॲप वापरण्यासाठी कॅमेरा आणि लोकेशनची परवानगी आवश्यक आहे. पेज रिफ्रेश करा."); 
            } 
        });
    </script>
</body>

</html>
