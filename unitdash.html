
<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>युनिट डॅशबोर्ड - अनिक फायनान्शियल सर्व्हिसेस</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #0078d4;
            --primary-rgb: 0, 120, 212; 
            --secondary-color: #0056b3;
            --success-color: #107c10;
            --danger-color: #e81123;
            --warning-color: #ffb900;
            --info-color: #00bcd4;
            --light-bg: #f5f5f5;
            --white-color: #ffffff; 
            --dark-text: #202020;
            --light-text: #6c757d; 
            --border-color: #e0e0e0;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 8px;
            --font-stack: 'Poppins', 'Noto Sans Devanagari', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-stack);
            background-color: var(--light-bg); margin: 0; color: var(--dark-text);
            line-height: 1.6;
        }
        .dashboard-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .dashboard-header {
            background-color: var(--white-color); padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 20px; box-shadow: var(--card-shadow);
            border-top: 5px solid var(--primary-color);
        }
        .dashboard-header h1 { margin: 0; font-size: 2rem; display: flex; align-items: center; gap: 15px; font-weight: 700; color: var(--secondary-color); }
        .dashboard-header img { height: 40px; }

        .filter-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; background-color: var(--white-color); padding: 20px;
            border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--card-shadow);
        }
        .filter-group label { font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9rem; }
        .filter-group input, .filter-group select {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);
            font-size: 1rem; font-family: inherit; transition: border-color 0.2s;
        }
        .filter-group input:focus, .filter-group select:focus { border-color: var(--primary-color); outline: none; }

        .kpi-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .kpi-card {
            background-color: var(--white-color); border-radius: var(--border-radius); 
            padding: 15px;
            display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--color);
            box-shadow: var(--card-shadow); transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 6px 14px rgba(var(--primary-rgb), 0.2); cursor: pointer; }
        .kpi-icon {
            font-size: 1.8rem; width: 50px; height: 50px; border-radius: 50%; display: grid;
            place-items: center; color: var(--color); background-color: rgba(var(--rgb-color), 0.15); flex-shrink: 0;
        }
        .kpi-content h3 { margin: 0 0 3px 0; font-size: 2rem; font-weight: 700; color: var(--dark-text); }
        .kpi-content p { margin: 0; color: var(--light-text); font-weight: 500; font-size: 0.85rem; }
        #kpi-total { --color: var(--primary-color); --rgb-color: var(--primary-rgb); }
        #kpi-pending { --color: var(--warning-color); --rgb-color: 255, 185, 0; }
        #kpi-approved { --color: var(--success-color); --rgb-color: 16, 124, 16; }
        #kpi-rejected { --color: var(--danger-color); --rgb-color: 232, 17, 35; }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .insights-card { border-left-color: var(--info-color) !important; --color: var(--info-color); --rgb-color: 0, 188, 212; padding: 15px; }
        .insights-card:hover { box-shadow: 0 8px 16px rgba(0, 188, 212, 0.2) !important; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-card { background: var(--white-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); }
        .grid-card-full { grid-column: 1 / -1; }
        .grid-card h2 { margin-top: 0; border-bottom: 3px solid var(--border-color); padding-bottom: 10px; font-size: 1.5rem; font-weight: 600; color: var(--primary-color); }
        .grid-card p { color: var(--light-text); margin-bottom: 15px; font-size: 0.95rem; }
        .chart-container { height: 350px; position: relative; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fefefe; margin: 4% auto; padding: 30px; border: none; width: 95%; max-width: 1400px; border-radius: var(--border-radius); animation: fadeIn 0.4s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { flex-grow: 1; margin: 0; }
        .close-btn { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--danger-color); }

        #modal-table-container { max-height: 70vh; overflow-y: auto; }
        #modal-table { width: 100%; border-collapse: collapse; }
        #modal-table th, #modal-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; font-size: 0.9em; vertical-align: middle; }
        #modal-table th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; }
        
        .action-btn-group { display: flex; gap: 6px; justify-content: flex-start; }
        .row-action-btn {
            padding: 6px 10px;
            font-size: 1em; /* Icon size */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .row-action-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .row-action-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .print-btn { background-color: var(--info-color); }
        .excel-btn { background-color: var(--success-color); }
        .photos-btn { background-color: #512da8; } /* Purple */
        .docs-btn { background-color: var(--secondary-color); }

        #file-modal-body { max-height: 60vh; overflow-y: auto; padding: 10px; }
        
        /* --- NEW STYLES FOR PHOTO GRID & DOCUMENT LIST --- */
        .file-link-list { display: flex; flex-direction: column; gap: 12px; }
        .file-link {
            display: block; padding: 10px 15px; background-color: #f0f0f0; border-radius: 5px;
            text-decoration: none; color: var(--dark-text); font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            word-break: break-all;
        }
        .file-link:hover { background-color: var(--primary-color); color: white; }
        .file-link i { margin-left: 10px; }

        .photo-thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .photo-thumbnail {
            display: block;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .photo-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .photo-thumbnail img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }
        .modal-footer { text-align: right; padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 10px; }
        
        #print-area { visibility: hidden; position: absolute; left: -9999px; top: -9999px; height: 1px; width: 1px; overflow: hidden; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: static; width: auto; height: auto; overflow: visible; left: auto; top: auto; }
        }
    </style>
</head>
<body>
    <div id="loader" style="display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999;"><div class="spinner" style="border: 8px solid #f3f3f3; border-top: 8px solid #0078d4; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;"></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style></div>
    
    <div class="dashboard-container">
        <header class="dashboard-header"><h1><img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" alt="Logo">युनिट परफॉर्मन्स डॅशबोर्ड</h1></header>
        <section class="filter-bar"><div class="filter-group"><label for="customer-search">ग्राहक नावाने शोधा</label><input type="search" id="customer-search" placeholder="ग्राहकाचे नाव टाईप करा..."></div><div class="filter-group"><label for="unit-filter">युनिट निवडा</label><select id="unit-filter"></select></div><div class="filter-group"><label for="staff-filter">कर्मचारी निवडा</label><select id="staff-filter"></select></div><div class="filter-group"><label for="date-from">या तारखेपासून</label><input type="date" id="date-from"></div><div class="filter-group"><label for="date-to">या तारखेपर्यंत</label><input type="date" id="date-to"></div></section>
        <section class="kpi-container"><div class="kpi-card clickable" id="kpi-total" data-status="Total"><div class="kpi-icon"><i class="fas fa-file-alt"></i></div><div class="kpi-content"><h3 id="total-count">0</h3><p>एकूण अर्ज</p></div></div><div class="kpi-card clickable" id="kpi-pending" data-status="Pending"><div class="kpi-icon"><i class="fas fa-hourglass-half"></i></div><div class="kpi-content"><h3 id="pending-count">0</h3><p>प्रोसेस / प्रलंबित</p></div></div><div class="kpi-card clickable" id="kpi-approved" data-status="Approved"><div class="kpi-icon"><i class="fas fa-check-double"></i></div><div class="kpi-content"><h3 id="approved-count">0</h3><p>मंजूर अर्ज</p></div></div><div class="kpi-card clickable" id="kpi-rejected" data-status="Rejected"><div class="kpi-icon"><i class="fas fa-times-circle"></i></div><div class="kpi-content"><h3 id="rejected-count">0</h3><p>नामंजूर अर्ज</p></div></div></section>
        <section class="grid-card grid-card-full" id="customer-insights-section"><h2>मंजूर अर्जदारांचे विशेष विश्लेषण (Approved Customer Insights)</h2><p>खालील कार्ड्स फक्त मंजूर झालेल्या अर्जांमधून तयार केलेले मुख्य ग्राहक अंतर्दृष्टी (Insights) दर्शवतात.</p><div class="dynamic-kpi-container insights-grid" id="approved-insights-container" style="margin-top: 20px;"></div></section>
        <section class="dashboard-grid"><div class="grid-card"><h2>कर्ज प्रकारानुसार अर्ज वितरण</h2><div class="chart-container"><canvas id="loanTypeChart"></canvas></div></div><div class="grid-card"><h2>तालुक्यानुसार अर्ज वितरण</h2><div class="chart-container"><canvas id="talukaChart"></canvas></div></div></section>
    </div>

    <!-- Modal for showing applicant lists -->
    <div id="applicant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">अर्जदारांची यादी</h2>
                <span class="close-btn applicant-modal-close">&times;</span>
            </div>
            <div id="modal-table-container">
                <table id="modal-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for showing individual file links -->
    <div id="file-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; margin-top: 5%;">
            <div class="modal-header">
                <h2 id="file-modal-title">फाइल्स</h2>
                <span class="close-btn file-modal-close">&times;</span>
            </div>
            <div id="file-modal-body">
                <!-- Content (photo grid or file list) will be injected here -->
            </div>
            <div class="modal-footer">
                <button id="download-zip-btn" class="row-action-btn excel-btn"><i class="fas fa-file-archive"></i> सर्व फाइल्स .zip डाउनलोड करा</button>
            </div>
        </div>
    </div>
    
    <div id="print-area"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPURxNiuk3u1oRGA9WWSj6ec_zaOzALeYt4j3TIIRtdQCtBrNJq_TNgBkjO1H5SCM/exec';

        const MARATHI_LABELS = { actualTime: "अर्जाची वेळ/तारीख", timestamp: "अर्जाची वेळ/तारीख", customerName: "नाव", applicantAge: "वय", applicantGender: "लिंग", mobileNumber: "मोबाईल क्रमांक", aadhaarNumber: "आधार क्रमांक", panNumber: "पॅन क्रमांक", villageName: "गावाचे नांव", taluka: "तालुका", district: "जिल्हा", centerName: "केंद्राचे नाव/कोड", gpsLatitude: "GPS अक्षांश", gpsLongitude: "GPS रेखांश", gpsAddress: "GPS नुसार पत्ता", googleMapsLink: "Google Maps लिंक", coApplicantName: "सहकर्जदार/पती/पत्नीचे नाव", coApplicantAadhaar: "सहकर्जदार आधार नंबर", coApplicantPan: "सहकर्जदार पॅन नंबर", isExistingCustomer: "सध्या अनिकचे ग्राहक आहात?", existingAccountNumber: "सध्याचा खाते क्रमांक", branchName: "शाखेचे नाव", familyTotalMembers: "घरातील एकूण सदस्य", familyEarningMembers: "कमावणारे सदस्य", familyTotalIncome: "एकूण मासिक उत्पन्न (रु)", expenseHousehold: "घरखर्च (रु)", expenseEducation: "शिक्षण खर्च (रु)", expenseMedical: "वैद्यकीय खर्च (रु)", expenseOther: "इतर खर्च (रु)", expenseTotal: "एकूण मासिक खर्च (रु)", primaryIncomeSource: "प्राथमिक उत्पन्न स्रोत", primaryIncomeTypeDetails: "प्राथमिक उत्पन्नाचा तपशील", secondaryIncomeSource: "दुय्यम उत्पन्न स्रोत", secondaryIncomeAmount: "दुय्यम मासिक उत्पन्न (रु)", assetLandAcres: "जमीन (एकर)", assetLandType: "जमीनीचा प्रकार", assetHouseType: "घराचा प्रकार", assetPlots: "प्लॉट्स/Shopes", cows: "गायी", buffaloes: "म्हशी", goats: "बकऱ्या/मेंढ्या", 'other livestok': "इतर", bulls: "बैलजोडी", pigs: "वराह पालन", poultry: "कोंबड्या", milkProductionLiters: "दुग्धउत्पादन किती होते (लिटर मध्ये उल्लेख करा)", assetEquipmentFarm: "शेतीसाठीची उपकरणे", assetEquipmentBusiness: "व्यवसायासाठीची उपकरणे", assetVehicle: "वाहन (उदा. दुचाकी, ट्रॅक्टर)", savingsBankAccount: "बँक खाते क्रमांक", savingsPigmy: "पिग्मी खाते", savingsInsurancePolicy: "विमा पॉलिसी", savingsInsuranceType: "विमा प्रकार", savingsOther: "इतर बचत/गुंतवणूक", loanAmountRequested: "मागितलेली रक्कम (रु)", previousLoanSource: "यापूर्वी कुठून कर्ज घेतले?", loanPurpose: "कर्जाचा उद्देश", previousLoanDetails: "मागील कर्ज तपशील (बाकी रक्कम)", repaymentPeriod: "परतफेड कालावधी (महिने)", guarantorDetails: "हमीदाराची माहिती", loanCycle: "कर्ज सायकल (कितवे कर्ज?)", loanProductType: "कर्ज प्रकार", maritalStatus: "वैवाहिक स्थिती", educationLevel: "शिक्षण", existingEMI: "इतर कर्जाचा चालू EMI", VerificationStatus: "सद्यस्थिती (Status)", fieldOfficerName: "क्षेत्र अधिकारी", Unit: "युनिट", remarks: "शेरा (Remarks)", visitDate: "भेटीची तारीख", IsInfoCorrect: "माहिती बरोबर आहे का?", IsVideoCallDone: "व्हिडिओ कॉल झाला का?", ApprovedLoanAmount: "मंजूर कर्ज रक्कम", VerifierRemarks: "पडताळणी शेरा", VerifierName: "पडताळणी करणाऱ्याचे नाव", VerificationTimestamp: "पडताळणीची वेळ", photoLinks: "फोटो लिंक्स", supportdoc: "जोडलेली कागदपत्रे"};
        const INSIGHT_KPIS = [{ key: 'highIncome', label: 'उच्च मासिक उत्पन्न (>रु 30K)', icon: 'fas fa-sack-dollar', filter: (d) => parseInt(d.familyTotalIncome || 0) >= 30000 },{ key: 'bagayatiLand', label: 'बागायती जमीन असलेले ग्राहक', icon: 'fas fa-seedling', filter: (d) => d.assetLandType && d.assetLandType.includes('बागायती') },{ key: 'milkingCows', label: 'गाई असलेले ग्राहक', icon: 'fas fa-cow', filter: (d) => parseInt(d.cows || 0) > 0 },{ key: 'pigmyAccount', label: 'पिग्मी खाते असलेले ग्राहक', icon: 'fas fa-piggy-bank', filter: (d) => d.savingsPigmy === 'होय' },{ key: 'businessLoan', label: 'व्यवसायासाठी कर्ज मागणारे', icon: 'fas fa-store', filter: (d) => d.loanPurpose && d.loanPurpose.includes('व्यवसाय') },{ key: 'highLoanCycle', label: 'पुनरावृत्ती (Repeat) कर्जदार (>= 3 सायकल)', icon: 'fas fa-redo-alt', filter: (d) => parseInt(d.loanCycle || 0) >= 3 },{ key: 'houseOwner', label: 'स्वतःच्या मालकीचे घर असलेले', icon: 'fas fa-home', filter: (d) => d.assetHouseType && d.assetHouseType.includes('स्वतः') },{ key: 'maxLoanAmount', label: 'मोठी कर्ज मागणी (>रु 1 लाख)', icon: 'fas fa-hand-holding-usd', filter: (d) => parseInt(d.loanAmountRequested || 0) > 100000 }];
        const PRINT_ALLOWED_STATUSES = ['Approved', 'Rejected'];
        
        let allData = [];
        let filteredData = [];
        let chartInstances = {};
        
        const ui = { loader: document.getElementById('loader'), customerSearch: document.getElementById('customer-search'), unitFilter: document.getElementById('unit-filter'), staffFilter: document.getElementById('staff-filter'), dateFrom: document.getElementById('date-from'), dateTo: document.getElementById('date-to'), kpi: { total: document.getElementById('total-count'), pending: document.getElementById('pending-count'), approved: document.getElementById('approved-count'), rejected: document.getElementById('rejected-count'), }, approvedInsightsContainer: document.getElementById('approved-insights-container'), applicantModal: document.getElementById('applicant-modal'), modalTitle: document.getElementById('modal-title'), applicantModalCloseBtn: document.querySelector('.applicant-modal-close'), printArea: document.getElementById('print-area'), fileModal: document.getElementById('file-modal'), fileModalTitle: document.getElementById('file-modal-title'), fileModalBody: document.getElementById('file-modal-body'), fileModalCloseBtns: document.querySelectorAll('.file-modal-close'), downloadZipBtn: document.getElementById('download-zip-btn') };

        window.addEventListener('load', initializeDashboard);

        async function initializeDashboard() {
            ui.loader.style.display = 'flex';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'success') {
                    allData = result.data.map(row => ({ ...row, actualTime: row.actualTime || row.timestamp, VerificationStatus: row.VerificationStatus || 'Pending' })).sort((a, b) => {
                        const dateA = parseDate(a.actualTime); const dateB = parseDate(b.actualTime); return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
                    });
                    setupFilters(); setupEventListeners(); applyFiltersAndRender();
                } else { throw new Error(result.message); }
            } catch (error) { document.body.innerHTML = `<p style="text-align:center; padding:20px; color:red;">डॅशबोर्ड लोड करताना गंभीर त्रटी आली: ${error.message}</p>`; } 
            finally { ui.loader.style.display = 'none'; }
        }

        function parseDate(d) { if (!d || typeof d !== 'string') return null; d = d.trim(); let D = null; let m = d.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})(.+)?/); if (m) { const iso = `${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`; const t = m[4] ? m[4].trim() : ''; D = new Date(`${iso}T${t.replace(/ /g,'T')}`); if (isNaN(D.getTime())) D = new Date(iso); if (!isNaN(D.getTime())) return D; } D = new Date(d); return !isNaN(D.getTime()) ? D : null; }
        function formatDate(d) { const D = parseDate(d); return D ? D.toLocaleDateString('en-GB').replace(/\//g, '-') : 'N/A'; }
        function setupFilters() { const u = [...new Set(allData.map(d => d.Unit).filter(Boolean))].sort(); const s = [...new Set(allData.map(d => d.fieldOfficerName).filter(Boolean))].sort(); ui.unitFilter.innerHTML = '<option value="">सर्व युनिट</option>' + u.map(i => `<option value="${i}">${i}</option>`).join(''); ui.staffFilter.innerHTML = '<option value="">सर्व कर्मचारी</option>' + s.map(i => `<option value="${i}">${i}</option>`).join(''); }
        
        function setupEventListeners() {
            [ui.customerSearch, ui.unitFilter, ui.staffFilter, ui.dateFrom, ui.dateTo].forEach(el => el.addEventListener('input', applyFiltersAndRender));
            document.querySelectorAll('.kpi-card.clickable').forEach(c => c.addEventListener('click', () => showStatusApplicantsModal(c.dataset.status)));
            ui.applicantModalCloseBtn.onclick = () => ui.applicantModal.style.display = "none";
            ui.fileModalCloseBtns.forEach(btn => btn.onclick = () => ui.fileModal.style.display = "none");
            window.onclick = (e) => {
                if (e.target == ui.applicantModal) ui.applicantModal.style.display = "none";
                if (e.target == ui.fileModal) ui.fileModal.style.display = "none";
            };
        }

        function applyFiltersAndRender() { const s = ui.customerSearch.value.toLowerCase(), u = ui.unitFilter.value, f = ui.staffFilter.value, dF = ui.dateFrom.value ? parseDate(ui.dateFrom.value) : null, dT = ui.dateTo.value ? parseDate(ui.dateTo.value) : null; if (dT) dT.setHours(23, 59, 59, 999); if (dF) dF.setHours(0, 0, 0, 0); filteredData = allData.filter(d => (!s || (d.customerName && d.customerName.toLowerCase().includes(s))) && (!u || d.Unit === u) && (!f || d.fieldOfficerName === f) && (!dF || (parseDate(d.actualTime) && parseDate(d.actualTime).getTime() >= dF.getTime())) && (!dT || (parseDate(d.actualTime) && parseDate(d.actualTime).getTime() <= dT.getTime()))); updateKPIs(); renderCharts(); generateApprovedCustomerInsights(); }
        function updateKPIs() { ui.kpi.total.textContent = filteredData.length; ui.kpi.pending.textContent = filteredData.filter(d => d.VerificationStatus === 'Pending').length; ui.kpi.approved.textContent = filteredData.filter(d => d.VerificationStatus === 'Approved').length; ui.kpi.rejected.textContent = filteredData.filter(d => d.VerificationStatus === 'Rejected').length; }
        function renderCharts() {['loanTypeChart', 'talukaChart'].forEach((id, i) => { if (chartInstances[id]) chartInstances[id].destroy(); const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return; const field = i === 0 ? 'loanProductType' : 'taluka'; const counts = filteredData.reduce((a, item) => { const k = item[field] || 'माहिती नाही'; a[k] = (a[k] || 0) + 1; return a; }, {}); const colors = ['#0078d4', '#28a745', '#ffb900', '#e81123', '#17a2b8', '#6c757d', '#512da8']; chartInstances[id] = new Chart(ctx, { type: i === 0 ? 'doughnut' : 'bar', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map((_, i) => colors[i % colors.length]) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: i === 0, position: 'bottom' } }, scales: i === 1 ? { y: { beginAtZero: true } } : {} } }); }); }
        function generateApprovedCustomerInsights() { const approvedData = filteredData.filter(d => d.VerificationStatus === 'Approved'); ui.approvedInsightsContainer.innerHTML = ''; INSIGHT_KPIS.forEach(kpi => { const count = approvedData.filter(kpi.filter).length; ui.approvedInsightsContainer.innerHTML += `<div class="kpi-card clickable insights-card" data-kpi-key="${kpi.key}" data-kpi-label="${kpi.label}"><div class="kpi-icon"><i class="${kpi.icon}"></i></div><div class="kpi-content"><h3>${count}</h3><p>${kpi.label}</p></div></div>`; }); ui.approvedInsightsContainer.querySelectorAll('.clickable').forEach(card => card.addEventListener('click', (e) => showApprovedInsightDetailsModal(e.currentTarget.dataset.kpiKey, e.currentTarget.dataset.kpiLabel))); }
        function showApprovedInsightDetailsModal(k, l) { const a = filteredData.filter(d => d.VerificationStatus === 'Approved'); const kpi = INSIGHT_KPIS.find(i => i.key === k); if (!kpi) return; const data = a.filter(kpi.filter); ui.modalTitle.textContent = `${l} (${data.length})`; const t = document.getElementById('modal-table'); t.innerHTML = `<thead><tr><th>ग्राहक</th><th>गाव</th><th>मोबाईल</th><th>कर्ज मागणी</th></tr></thead><tbody></tbody>`; const tbody = t.querySelector('tbody'); tbody.innerHTML = data.length === 0 ? `<tr><td colspan="4" style="text-align:center;">या गटात मंजूर अर्जदार नाहीत.</td></tr>` : data.map(i => `<tr><td>${i.customerName || 'N/A'}</td><td>${i.villageName || 'N/A'}</td><td>${i.mobileNumber || 'N/A'}</td><td>₹ ${parseInt(i.loanAmountRequested || 0).toLocaleString('en-IN')}</td></tr>`).join(''); ui.applicantModal.style.display = 'block'; }
        
        function showStatusApplicantsModal(status) {
            let data, statusMarathi;
            if (status === 'Total') { data = filteredData; statusMarathi = 'एकूण'; } 
            else {
                data = filteredData.filter(d => d.VerificationStatus === status);
                if (status === 'Pending') statusMarathi = 'प्रोसेस / प्रलंबित';
                else if (status === 'Approved') statusMarathi = 'मंजूर';
                else if (status === 'Rejected') statusMarathi = 'नामंजूर';
            }
            
            ui.modalTitle.textContent = `${statusMarathi} अर्जदारांची यादी (${data.length})`;
            
            const modalTable = document.getElementById('modal-table');
            const hasActions = PRINT_ALLOWED_STATUSES.includes(status);
            let headerHTML = `<thead><tr><th>ग्राहक</th><th>गाव</th><th>मोबाईल</th><th>अर्ज तारीख</th><th>कर्ज मागणी</th><th>मंजूर रक्कम</th>`;
            if (hasActions) headerHTML += `<th style="width: 200px;">कृती (Actions)</th>`;
            headerHTML += `</tr></thead><tbody></tbody>`;
            modalTable.innerHTML = headerHTML;
            
            const tbody = modalTable.querySelector('tbody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${hasActions ? 7 : 6}" style="text-align:center;">या गटात एकही अर्ज नाही.</td></tr>`;
            } else {
                tbody.innerHTML = data.map(item => {
                    let actionCellHTML = '';
                    if (status === 'Approved') {
                        const hasPhotos = item.photoLinks && item.photoLinks.trim() !== '';
                        const hasDocs = item.supportdoc && item.supportdoc.trim() !== '';
                        actionCellHTML = `
                        <div class="action-btn-group">
                            <button class="row-action-btn print-btn" title="रिपोर्ट प्रिंट करा" data-row="${item.row}"><i class="fas fa-print"></i></button>
                            <button class="row-action-btn excel-btn" title="एक्सेलमध्ये एक्सपोर्ट करा" data-row="${item.row}"><i class="fas fa-file-excel"></i></button>
                            <button class="row-action-btn photos-btn" title="फोटो पहा" data-row="${item.row}" ${!hasPhotos ? 'disabled' : ''}><i class="fas fa-camera"></i></button>
                            <button class="row-action-btn docs-btn" title="कागदपत्रे पहा" data-row="${item.row}" ${!hasDocs ? 'disabled' : ''}><i class="fas fa-file-alt"></i></button>
                        </div>`;
                    } else if (status === 'Rejected') {
                        actionCellHTML = `<button class="row-action-btn print-btn" title="रिपोर्ट प्रिंट करा" data-row="${item.row}"><i class="fas fa-print"></i></button>`;
                    }

                    return `<tr>
                        <td>${item.customerName || 'N/A'}</td>
                        <td>${item.villageName || 'N/A'}</td>
                        <td>${item.mobileNumber || 'N/A'}</td> 
                        <td>${formatDate(item.actualTime)}</td>
                        <td>₹ ${parseInt(item.loanAmountRequested || 0).toLocaleString('en-IN')}</td>
                        <td>₹ ${parseInt(item.ApprovedLoanAmount || 0).toLocaleString('en-IN')}</td>
                        ${hasActions ? `<td>${actionCellHTML}</td>` : ''}
                    </tr>`;
                }).join('');
            }
            
            ui.applicantModal.style.display = "block";
            
            modalTable.querySelectorAll('.row-action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const rowId = parseInt(button.dataset.row);
                    const applicantData = allData.find(d => d.row === rowId);
                    if (!applicantData) return;

                    if (button.classList.contains('print-btn')) {
                        printReport(applicantData);
                    } else if (button.classList.contains('excel-btn')) {
                        exportDataToExcel([applicantData], `Applicant_${applicantData.customerName || rowId}`);
                    } else if (button.classList.contains('photos-btn')) {
                        showFilesModal(applicantData, 'photoLinks', 'फोटो');
                    } else if (button.classList.contains('docs-btn')) {
                        showFilesModal(applicantData, 'supportdoc', 'कागदपत्रे');
                    }
                });
            });
        }
        
        // --- IMPROVED FUNCTION TO SHOW ALL PHOTOS/DOCS ---
        function showFilesModal(applicantData, linkFieldKey, fileType) {
            ui.fileModalTitle.textContent = `${applicantData.customerName || 'अर्जदार'} यांचे ${fileType}`;
            const urlString = applicantData[linkFieldKey] || '';
            // Robustly split by comma, space, or newline and filter out empty entries
            const urls = urlString.split(/[\s,]+/).filter(url => url.trim() !== '');

            if (urls.length === 0) {
                ui.fileModalBody.innerHTML = `<p style="text-align:center;">या अर्जदारासाठी कोणत्याही ${fileType} फाइल्स सापडल्या नाहीत.</p>`;
                ui.downloadZipBtn.style.display = 'none';
            } else {
                if (fileType === 'फोटो') {
                    // Display a grid of photo thumbnails
                    ui.fileModalBody.innerHTML = `<div class="photo-thumbnail-grid">` + 
                        urls.map(url => `
                            <a href="${url}" target="_blank" class="photo-thumbnail">
                                <img src="${url}" alt="Photo Thumbnail" loading="lazy">
                            </a>
                        `).join('') + 
                    `</div>`;
                } else {
                    // Display a list of document links
                    ui.fileModalBody.innerHTML = `<div class="file-link-list">` + 
                        urls.map((url, index) => `
                            <a href="${url}" target="_blank" class="file-link">
                                ${fileType} ${index + 1} <i class="fas fa-external-link-alt"></i>
                            </a>
                        `).join('') +
                    `</div>`;
                }

                ui.downloadZipBtn.style.display = 'inline-flex';
                ui.downloadZipBtn.onclick = (e) => {
                    downloadAllFilesAsZip(e.currentTarget, urls, `${fileType}_${applicantData.customerName || applicantData.row}`);
                };
            }
            ui.fileModal.style.display = 'block';
        }
        
        function exportDataToExcel(data, filename = "Report") {
            try {
                const mappedData = data.map(row => {
                    const newRow = {};
                    Object.keys(row).forEach(key => { if (MARATHI_LABELS[key]) newRow[MARATHI_LABELS[key]] = row[key]; });
                    return newRow;
                });
                const worksheet = XLSX.utils.json_to_sheet(mappedData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
                XLSX.writeFile(workbook, `${filename.replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`);
            } catch (error) { console.error("Excel Export Error:", error); alert("एक्सेल फाइल तयार करताना त्रुटी आली."); }
        }

        async function downloadAllFilesAsZip(button, urls, zipFileName) {
            const originalIconHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> डाउनलोड होत आहे...`;
            try {
                const zip = new JSZip();
                if (urls.length === 0) { alert(`या अर्जदारासाठी फाइल्स आढळल्या नाहीत.`); return; }
                
                const filePromises = urls.map(async (url, index) => {
                    try {
                        // Use a proxy to bypass potential CORS issues with Google Drive links
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error(`Fetch failed for ${url}`);
                        const blob = await response.blob();
                        const fileExtension = blob.type.split('/')[1] || 'jpg';
                        const fileName = `${zipFileName.split('_')[0]}_${index + 1}.${fileExtension}`;
                        zip.file(fileName, blob);
                    } catch (e) {
                        console.error(`Failed to download ${url}:`, e);
                        zip.file(`FAILED_Download_${index + 1}.txt`, `Failed to download: ${url}\nError: ${e.message}\nNote: Google Drive links might require a CORS proxy to work.`);
                    }
                });

                await Promise.all(filePromises);
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `${zipFileName.replace(/[^a-zA-Z0-9]/g, '_')}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) { console.error(`ZIP Error:`, error); alert(`ZIP फाइल तयार करताना त्रुटी आली. कृपया ब्राउझरच्या कॉन्सोलमध्ये त्रुटी तपासा.`); } 
            finally { button.disabled = false; button.innerHTML = originalIconHTML; }
        }
        
        function printReport(data) {
            if (!data) {
                console.error("Print Error: No data provided for report.");
                return;
            }
            generatePrintHTML(data);
        }

        function formatDateTimeForPrint(d) { const D = parseDate(d); if (!D) return 'N/A'; return `${D.toLocaleDateString('en-GB').replace(/\//g,'-')} ${D.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true })}`; }
        
        function generatePrintHTML(data) { 
            const logoUrl = "https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png"; 
            const mapImageUrl = (data.gpsLatitude && data.gpsLongitude) ? `https://static-maps.yandex.ru/1.x/?ll=${data.gpsLongitude},${data.gpsLatitude}&z=17&l=sat,skl&size=650,450&pt=${data.gpsLongitude},${data.gpsLatitude},pm2rdl` : ''; 
            const gmapLink = (data.gpsLatitude && data.gpsLongitude) ? `https://www.google.com/maps?q=${data.gpsLatitude},${data.gpsLongitude}` : ''; 
            const BASIC_KEYS = ['customerName', 'applicantAge', 'applicantGender', 'maritalStatus', 'educationLevel', 'mobileNumber', 'aadhaarNumber', 'panNumber', 'villageName', 'taluka', 'district', 'loanProductType', 'loanAmountRequested', 'ApprovedLoanAmount', 'VerificationStatus', 'actualTime']; 
            let detailsHTML = `<div class="print-page"><style> .print-page{padding:10mm; font-family: 'Noto Sans Devanagari', sans-serif;} .print-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #0056b3;padding-bottom:10px;margin-bottom:15px} .print-header img{height:30px} .print-header h1{margin:0;font-size:16pt;color:#0056b3} .section-title{font-size:12pt;color:#555;padding:5px 0;margin-top:15px;border-bottom:1px dotted #ccc} .print-table{width:100%;border-collapse:collapse;margin-bottom:15px} .print-table td{padding:5px 10px;border:1px solid #ddd; font-size: 10pt;} .print-table tr td:first-child{width:35%;font-weight:bold;background-color:#f8f8fa} .photo-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px} .print-photo-container{width:calc(50% - 5px);border:1px solid #eee;padding:8px;box-sizing:border-box;page-break-inside:avoid} .print-photo-container p{margin:0;font-size:9pt} .print-photo-container a{word-break:break-all;font-size:8pt} .map-container img{max-width:100%;height:auto;margin-top:10px;border:1px solid #ddd} .print-footer{text-align:center;margin-top:20px;padding-top:10px;border-top:1px solid #ccc;font-size:8pt;color:#999} @media print { @page { size: A4; margin: 1cm; } body { -webkit-print-color-adjust: exact; } .print-page { margin: 0; } } </style><div class="print-header"><img src="${logoUrl}" alt="Logo"><h1>GPS व्हेरिफिकेशन अहवाल</h1></div><h3 class="section-title">अर्जदाराची मूलभूत माहिती</h3><table class="print-table">`; 
            BASIC_KEYS.forEach(key => { const value = data[key]; if (value && String(value).trim()) { let displayValue = value; if (key === 'actualTime') displayValue = formatDateTimeForPrint(value); else if (key.includes('Amount') || key.includes('Requested')) displayValue = `रु ${parseInt(value || 0).toLocaleString('en-IN')}`; detailsHTML += `<tr><td>${MARATHI_LABELS[key] || key}</td><td>${displayValue}</td></tr>`; } }); 
            detailsHTML += `</table>`; 
            const EXCLUDED_KEYS = [...BASIC_KEYS, 'timestamp', 'row', 'photoLinks', 'supportdoc', 'gpsLatitude', 'gpsLongitude', 'gpsAddress', 'googleMapsLink']; 
            let remainingInfo = ''; 
            Object.keys(data).forEach(key => { if (!EXCLUDED_KEYS.includes(key) && data[key] && String(data[key]).trim()) { let displayValue = data[key]; if (key.includes('Income') || key.includes('expense') || key.includes('Amount')) { const numVal = parseInt(String(data[key]).replace(/,/g, '') || 0); if (!isNaN(numVal) && numVal > 0) displayValue = `रु ${numVal.toLocaleString('en-IN')}`; } else if (key === 'VerificationTimestamp') { displayValue = formatDateTimeForPrint(data[key]); } remainingInfo += `<tr><td>${MARATHI_LABELS[key] || key}</td><td>${displayValue}</td></tr>`; } }); 
            if (remainingInfo) detailsHTML += `<h3 class="section-title">इतर तपशील</h3><table class="print-table">${remainingInfo}</table>`; 
            if (mapImageUrl) detailsHTML += `<h3 class="section-title">स्थानिक (GPS) पडताळणी</h3><div class="map-container" style="page-break-inside: avoid;"><p><strong>GPS पत्ता:</strong> ${data.gpsAddress || 'N/A'}</p><p><strong>Google Maps Link:</strong> <a href="${gmapLink}" target="_blank">${gmapLink}</a></p><img src="${mapImageUrl}" alt="Map"></div>`; 
            if (data.photoLinks && typeof data.photoLinks === 'string' && data.photoLinks.trim()) { detailsHTML += `<h3 class="section-title">छायाचित्र (लिंक्स)</h3><div class="photo-grid">`; data.photoLinks.split(/[\s,]+/).forEach((url, i) => { if (url.trim()) detailsHTML += `<div class="print-photo-container"><p>फोटो ${i+1}</p><a href="${url.trim()}" target="_blank">${url.trim()}</a></div>`; }); detailsHTML += `</div>`; } 
            if (data.supportdoc && typeof data.supportdoc === 'string' && data.supportdoc.trim()) { detailsHTML += `<h3 class="section-title">कागदपत्रे (लिंक्स)</h3><div class="photo-grid">`; data.supportdoc.split(/[\s,]+/).forEach((url, i) => { if (url.trim()) detailsHTML += `<div class="print-photo-container"><p>कागदपत्र ${i+1}</p><a href="${url.trim()}" target="_blank">${url.trim()}</a></div>`; }); detailsHTML += `</div>`; } 
            detailsHTML += `<div class="print-footer">हा रिपोर्ट ${new Date().toLocaleDateString('mr-IN')} रोजी स्वयंचलितपणे तयार झाला आहे.</div></div>`; 
            ui.printArea.innerHTML = detailsHTML; 
            
            const images = ui.printArea.querySelectorAll('img');
            const promises = [...images].map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });
            });

            Promise.all(promises).then(() => {
                window.print();
            });
        }
    </script>
</body>
</html>
