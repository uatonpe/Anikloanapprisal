<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>युनिट डॅशबोर्ड - अनिक फायनान्शियल सर्व्हिसेस</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0078d4; /* Power BI Blue */
            --primary-rgb: 0, 120, 212; 
            --secondary-color: #0056b3;
            --success-color: #107c10; /* Darker Green */
            --danger-color: #e81123; /* Darker Red */
            --warning-color: #ffb900;
            --info-color: #00bcd4;
            --light-bg: #f5f5f5; /* Lighter background */
            --white-color: #ffffff; 
            --dark-text: #202020;
            --light-text: #6c757d; 
            --border-color: #e0e0e0;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Stronger, cleaner shadow */
            --border-radius: 8px;
            --font-stack: 'Poppins', 'Noto Sans Devanagari', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-stack);
            background-color: var(--light-bg); margin: 0; color: var(--dark-text);
            line-height: 1.6;
        }
        .dashboard-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Header & Filters */
        .dashboard-header {
            background-color: var(--white-color); padding: 20px; border-radius: var(--border-radius);
            margin-bottom: 20px; box-shadow: var(--card-shadow);
            border-top: 5px solid var(--primary-color);
        }
        .dashboard-header h1 { margin: 0; font-size: 2rem; display: flex; align-items: center; gap: 15px; font-weight: 700; color: var(--secondary-color); }
        .dashboard-header img { height: 40px; }

        .filter-bar {
            /* Now 5 columns (Customer, Unit, Staff, Date From, Date To) */
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; background-color: var(--white-color); padding: 20px;
            border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--card-shadow);
        }
        .filter-group label { font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9rem; }
        .filter-group input, .filter-group select {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);
            font-size: 1rem; font-family: inherit; transition: border-color 0.2s;
        }
        .filter-group input:focus, .filter-group select:focus { border-color: var(--primary-color); outline: none; }

        /* KPI Cards (Status) - SIZE REDUCTION */
        .kpi-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .kpi-card {
            background-color: var(--white-color); border-radius: var(--border-radius); 
            padding: 15px; /* Reduced padding for smaller size */
            display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--color);
            box-shadow: var(--card-shadow); transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 6px 14px rgba(var(--primary-rgb), 0.2); cursor: pointer; }
        .kpi-icon {
            font-size: 1.8rem; width: 50px; height: 50px; border-radius: 50%; display: grid;
            place-items: center; color: var(--color); background-color: rgba(var(--rgb-color), 0.15); flex-shrink: 0;
        }
        .kpi-content h3 { margin: 0 0 3px 0; font-size: 2rem; font-weight: 700; color: var(--dark-text); } /* Slightly smaller h3 */
        .kpi-content p { margin: 0; color: var(--light-text); font-weight: 500; font-size: 0.85rem; }
        #kpi-total { --color: var(--primary-color); --rgb-color: var(--primary-rgb); border-left-color: var(--primary-color); }
        #kpi-pending { --color: var(--warning-color); --rgb-color: 255, 185, 0; border-left-color: var(--warning-color); }
        #kpi-approved { --color: var(--success-color); --rgb-color: 16, 124, 16; border-left-color: var(--success-color); }
        #kpi-rejected { --color: var(--danger-color); --rgb-color: 232, 17, 35; border-left-color: var(--danger-color); }

        /* Smart KPI Insights Grid */
        .insights-grid {
             display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
             gap: 20px; 
        }
        .insights-card {
             border-left-color: var(--info-color) !important;
             --color: var(--info-color); 
             --rgb-color: 0, 188, 212; 
             padding: 15px; /* Consistent smaller padding */
        }
        .insights-card:hover {
            box-shadow: 0 8px 16px rgba(0, 188, 212, 0.2) !important;
        }
        
        /* Charts and General Cards */
        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        .grid-card { 
            background: var(--white-color); padding: 25px; border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); transition: all 0.3s;
        }
        .grid-card-full { grid-column: 1 / -1; }
        .grid-card h2 { 
            margin-top: 0; 
            border-bottom: 3px solid var(--border-color); 
            padding-bottom: 10px; 
            font-size: 1.5rem; 
            font-weight: 600;
            color: var(--primary-color);
        }
        .grid-card p {
            color: var(--light-text);
            margin-bottom: 15px;
            font-size: 0.95rem; /* Ensure the paragraph text is clearly visible */
        }
        .chart-container { height: 350px; position: relative; }
        
        /* Modal Styles (omitted for brevity, assume standard styles are fine) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: #fefefe; margin: 4% auto; padding: 30px; border: none; width: 95%; max-width: 1400px; border-radius: var(--border-radius); animation: fadeIn 0.4s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-color); padding-bottom: 15px; margin-bottom: 20px; }
        .close-btn { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--danger-color); }

        #modal-table-container { max-height: 70vh; overflow-y: auto; }
        #modal-table { width: 100%; border-collapse: collapse; }
        #modal-table th, #modal-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; font-size: 0.9em; }
        #modal-table th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; }
        
        .print-btn { 
            background: var(--info-color); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; white-space: nowrap; 
            transition: background-color 0.2s;
        }
        .print-btn:hover { background: #008c99; }
        .print-btn i { margin-right: 5px; }
        
        /* Print Styles */
        #print-area { display: none; }
        @page { size: A4; margin: 10mm; }
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block; width: 100%; margin: 0; padding: 0; font-family: 'Noto Sans Devanagari', sans-serif; font-size: 10pt; color: #333; }
            .print-page { padding: 10mm; page-break-after: always; }
            .print-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 15px; }
            .print-header img { height: 30px; width: auto; }
            .print-header h1 { margin: 0; font-size: 16pt; color: #0056b3; text-align: right; }
            .section-title { font-size: 12pt; color: #555; padding: 5px 0; margin-top: 15px; border-bottom: 1px dotted #ccc; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            .print-table td { padding: 5px 10px; border: 1px solid #ddd; }
            .print-table tr td:first-child { width: 35%; font-weight: bold; background-color: #f8f8fa; }
            .photo-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
            .print-photo-container { width: calc(50% - 5px); border: 1px solid #eee; padding: 8px; box-sizing: border-box; page-break-inside: avoid; }
            .print-photo-container p { margin: 0; font-size: 9pt; }
            .print-photo-container a { word-break: break-all; font-size: 8pt; }
            .map-container img { max-width: 100%; height: auto; margin-top: 10px; border: 1px solid #ddd; }
            .print-footer { text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 8pt; color: #999; }
            .print-watermark { position: fixed; top: 40%; left: 10%; font-size: 72pt; color: rgba(0, 0, 0, 0.05); transform: rotate(-45deg); z-index: -1; }
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1><img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" alt="Logo">युनिट परफॉर्मन्स डॅशबोर्ड</h1>
        </header>

        <section class="filter-bar">
            <div class="filter-group">
                <label for="customer-search">ग्राहक नावाने शोधा</label>
                <input type="search" id="customer-search" placeholder="ग्राहकाचे नाव टाईप करा...">
            </div>
            <div class="filter-group">
                <label for="unit-filter">युनिट निवडा</label>
                <select id="unit-filter"></select>
            </div>
            <div class="filter-group">
                <label for="staff-filter">कर्मचारी निवडा</label>
                <select id="staff-filter"></select>
            </div>
            <!-- DATE FILTERS ADDED -->
            <div class="filter-group">
                <label for="date-from">या तारखेपासून</label>
                <input type="date" id="date-from">
            </div>
            <div class="filter-group">
                <label for="date-to">या तारखेपर्यंत</label>
                <input type="date" id="date-to">
            </div>
        </section>

        <section class="kpi-container">
            <!-- Core KPIs -->
            <div class="kpi-card clickable" id="kpi-total" data-status="Total">
                <div class="kpi-icon"><i class="fas fa-file-alt"></i></div>
                <div class="kpi-content"><h3 id="total-count">0</h3><p>एकूण अर्ज</p></div>
            </div>
            <div class="kpi-card clickable" id="kpi-pending" data-status="Pending">
                <div class="kpi-icon"><i class="fas fa-hourglass-half"></i></div>
                <div class="kpi-content"><h3 id="pending-count">0</h3><p>प्रोसेस / प्रलंबित</p></div>
            </div>
            <div class="kpi-card clickable" id="kpi-approved" data-status="Approved">
                <div class="kpi-icon"><i class="fas fa-check-double"></i></div>
                <div class="kpi-content"><h3 id="approved-count">0</h3><p>मंजूर अर्ज</p></div>
            </div>
            <div class="kpi-card clickable" id="kpi-rejected" data-status="Rejected">
                <div class="kpi-icon"><i class="fas fa-times-circle"></i></div>
                <div class="kpi-content"><h3 id="rejected-count">0</h3><p>नामंजूर अर्ज</p></div>
            </div>
        </section>

        <!-- New Section for Smart KPIs (Approved Customer Insights) -->
        <section class="grid-card grid-card-full" id="customer-insights-section">
            <h2>मंजूर अर्जदारांचे विशेष विश्लेषण (Approved Customer Insights)</h2>
            <!-- MISSING PARAGRAPH RESTORED/CONFIRMED -->
            <p>खालील कार्ड्स फक्त मंजूर झालेल्या अर्जांमधून तयार केलेले मुख्य ग्राहक अंतर्दृष्टी (Insights) दर्शवतात.</p>
            <div class="dynamic-kpi-container insights-grid" id="approved-insights-container" style="margin-top: 20px;">
                <!-- Smart KPIs will be rendered here -->
            </div>
        </section>

        <section class="dashboard-grid">
            <div class="grid-card">
                <h2>कर्ज प्रकारानुसार अर्ज वितरण</h2>
                <div class="chart-container"><canvas id="loanTypeChart"></canvas></div>
            </div>
            <div class="grid-card">
                <h2>तालुक्यानुसार अर्ज वितरण</h2>
                <div class="chart-container"><canvas id="talukaChart"></canvas></div>
            </div>
        </section>
    </div>

    <!-- Modal for showing applicant lists -->
    <div id="applicant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">अर्जदारांची यादी</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div id="modal-table-container">
                <table id="modal-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="print-area"></div>

    <script>
        // ***** येथे तुमची Apps Script URL टाका *****
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPURxNiuk3u1oRGA9WWSj6ec_zaOzALeYt4j3TIIRtdQCtBrNJq_TNgBkjO1H5SCM/exec';

        // =========================================================================================
        // === MARATHI LABELS DIRECTORY ===
        // =========================================================================================
        const MARATHI_LABELS = {
            // Basic Info & Core Application (KYC)
            actualTime: "अर्जाची वेळ/तारीख", 
            timestamp: "अर्जाची वेळ/तारीख", 
            customerName: "नाव",
            applicantAge: "वय",
            applicantGender: "लिंग",
            mobileNumber: "मोबाईल क्रमांक",
            aadhaarNumber: "आधार क्रमांक",
            panNumber: "पॅन क्रमांक",
            
            // Location
            villageName: "गावाचे नांव",
            taluka: "तालुका",
            district: "जिल्हा",
            centerName: "केंद्राचे नाव/कोड",
            gpsLatitude: "GPS अक्षांश",
            gpsLongitude: "GPS रेखांश",
            gpsAddress: "GPS नुसार पत्ता",
            googleMapsLink: "Google Maps लिंक",
            
            // Co-Applicant
            coApplicantName: "सहकर्जदार/पती/पत्नीचे नाव",
            coApplicantAadhaar: "सहकर्जदार आधार नंबर",
            coApplicantPan: "सहकर्जदार पॅन नंबर",

            // Existing Customer Details
            isExistingCustomer: "सध्या अनिकचे ग्राहक आहात?",
            existingAccountNumber: "सध्याचा खाते क्रमांक",
            branchName: "शाखेचे नाव",
            
            // Family & Income/Expense
            familyTotalMembers: "घरातील एकूण सदस्य",
            familyEarningMembers: "कमावणारे सदस्य",
            familyTotalIncome: "एकूण मासिक उत्पन्न (रु)",
            
            expenseHousehold: "घरखर्च (रु)",
            expenseEducation: "शिक्षण खर्च (रु)",
            expenseMedical: "वैद्यकीय खर्च (रु)",
            expenseOther: "इतर खर्च (रु)",
            expenseTotal: "एकूण मासिक खर्च (रु)",
            
            primaryIncomeSource: "प्राथमिक उत्पन्न स्रोत",
            primaryIncomeTypeDetails: "प्राथमिक उत्पन्नाचा तपशील",
            secondaryIncomeSource: "दुय्यम उत्पन्न स्रोत",
            secondaryIncomeAmount: "दुय्यम मासिक उत्पन्न (रु)",

            // Assets
            assetLandAcres: "जमीन (एकर)",
            assetLandType: "जमीनीचा प्रकार",
            assetHouseType: "घराचा प्रकार",
            assetPlots: "प्लॉट्स/Shopes",
            
            cows: "गायी",
            buffaloes: "म्हशी",
            goats: "बकऱ्या/मेंढ्या",
            'other livestok': "इतर", 
            bulls: "बैलजोडी",
            pigs: "वराह पालन",
            poultry: "कोंबड्या",
            
            milkProductionLiters: "दुग्धउत्पादन किती होते (लिटर मध्ये उल्लेख करा)",
            
            assetEquipmentFarm: "शेतीसाठीची उपकरणे",
            assetEquipmentBusiness: "व्यवसायासाठीची उपकरणे",
            assetVehicle: "वाहन (उदा. दुचाकी, ट्रॅक्टर)",
            
            // Savings
            savingsBankAccount: "बँक खाते क्रमांक",
            savingsPigmy: "पिग्मी खाते",
            savingsInsurancePolicy: "विमा पॉलिसी",
            savingsInsuranceType: "विमा प्रकार",
            savingsOther: "इतर बचत/गुंतवणूक",
            
            // Loan Details
            loanAmountRequested: "मागितलेली रक्कम (रु)",
            previousLoanSource: "यापूर्वी कुठून कर्ज घेतले?",
            loanPurpose: "कर्जाचा उद्देश",
            previousLoanDetails: "मागील कर्ज तपशील (बाकी रक्कम)",
            repaymentPeriod: "परतफेड कालावधी (महिने)",
            guarantorDetails: "हमीदाराची माहिती",
            loanCycle: "कर्ज सायकल (कितवे कर्ज?)",
            loanProductType: "कर्ज प्रकार",
            maritalStatus: "वैवाहिक स्थिती",
            educationLevel: "शिक्षण",
            existingEMI: "इतर कर्जाचा चालू EMI",

            // Verification & Status
            VerificationStatus: "सद्यस्थिती (Status)",
            fieldOfficerName: "क्षेत्र अधिकारी",
            Unit: "युनिट",
            remarks: "शेरा (Remarks)",
            visitDate: "भेटीची तारीख",
            
            IsInfoCorrect: "माहिती बरोबर आहे का?", 
            IsVideoCallDone: "व्हिडिओ कॉल झाला का?", 
            ApprovedLoanAmount: "मंजूर कर्ज रक्कम", 
            VerifierRemarks: "पडताळणी शेरा",
            VerifierName: "पडताळणी करणाऱ्याचे नाव", 
            VerificationTimestamp: "पडताळणीची वेळ",
            photoLinks: "फोटो लिंक्स",
        };
        // =========================================================================================

        // --- SMART KPI Definitions (Unchanged) ---
        const INSIGHT_KPIS = [
            { key: 'highIncome', label: 'उच्च मासिक उत्पन्न (>रु 30K)', icon: 'fas fa-sack-dollar', 
              filter: (d) => parseInt(d.familyTotalIncome || 0) >= 30000 },
              
            { key: 'bagayatiLand', label: 'बागायती जमीन असलेले ग्राहक', icon: 'fas fa-seedling', 
              filter: (d) => d.assetLandType && d.assetLandType.includes('बागायती') },
              
            { key: 'milkingCows', label: 'गाई असलेले ग्राहक', icon: 'fas fa-cow', 
              filter: (d) => parseInt(d.cows || 0) > 0 },
              
            { key: 'pigmyAccount', label: 'पिग्मी खाते असलेले ग्राहक', icon: 'fas fa-piggy-bank', 
              filter: (d) => d.savingsPigmy === 'होय' },

            { key: 'businessLoan', label: 'व्यवसायासाठी कर्ज मागणारे', icon: 'fas fa-store', 
              filter: (d) => d.loanPurpose && d.loanPurpose.includes('व्यवसाय') },

            { key: 'highLoanCycle', label: 'पुनरावृत्ती (Repeat) कर्जदार (>= 3 सायकल)', icon: 'fas fa-redo-alt', 
              filter: (d) => parseInt(d.loanCycle || 0) >= 3 },
            
            { key: 'houseOwner', label: 'स्वतःच्या मालकीचे घर असलेले', icon: 'fas fa-home', 
              filter: (d) => d.assetHouseType && d.assetHouseType.includes('स्वतः') },

            { key: 'maxLoanAmount', label: 'मोठी कर्ज मागणी (>रु 1 लाख)', icon: 'fas fa-hand-holding-usd', 
              filter: (d) => parseInt(d.loanAmountRequested || 0) > 100000 },
        ];


        const PRINT_ALLOWED_STATUSES = ['Approved', 'Rejected'];

        let allData = [];
        let filteredData = [];
        let chartInstances = {};

        const ui = {
            loader: document.getElementById('loader'),
            customerSearch: document.getElementById('customer-search'),
            unitFilter: document.getElementById('unit-filter'),
            staffFilter: document.getElementById('staff-filter'),
            dateFrom: document.getElementById('date-from'), 
            dateTo: document.getElementById('date-to'),     
            kpi: {
                total: document.getElementById('total-count'),
                pending: document.getElementById('pending-count'),
                approved: document.getElementById('approved-count'),
                rejected: document.getElementById('rejected-count'),
            },
            approvedInsightsContainer: document.getElementById('approved-insights-container'),
            modal: document.getElementById('applicant-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalCloseBtn: document.querySelector('.close-btn'),
            printArea: document.getElementById('print-area'),
        };

        window.addEventListener('load', initializeDashboard);

        async function initializeDashboard() {
            ui.loader.style.display = 'flex';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const result = await response.json();

                if (result.status === 'success') {
                    allData = result.data.map(row => ({
                        ...row,
                        actualTime: row.actualTime || row.timestamp, 
                        VerificationStatus: row.VerificationStatus || 'Pending'
                    })).sort((a, b) => {
                        // Sorting should ideally rely on robust date parsing too
                        const dateA = parseDate(a.actualTime);
                        const dateB = parseDate(b.actualTime);
                        return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
                    });
                    
                    setupFilters();
                    setupEventListeners();
                    applyFiltersAndRender();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                document.body.innerHTML = `<p style="text-align:center; padding:20px; color:red;">डॅशबोर्ड लोड करताना गंभीर त्रटी आली: ${error.message}</p>`;
            } finally {
                ui.loader.style.display = 'none';
            }
        }

        // =========================================================================================
        // दुरुस्त केलेला Date Parsing Utility
        // =========================================================================================
        
        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            dateStr = dateStr.trim();
            
            let date = null;

            // Try parsing DD/MM/YYYY or DD-MM-YYYY format first (Handles Google Sheet format)
            // It looks for D/M/Y or D-M-Y followed by optional time (.*)
            let match = dateStr.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})(.+)?/);
            
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                
                // Reconstruct to YYYY-MM-DD for reliable Date parsing
                const isoDatePart = `${year}-${month}-${day}`; 
                
                // Handle time component if present
                const timePart = match[4] ? match[4].trim() : '';
                
                // Attempt to create date object from ISO format + time
                date = new Date(`${isoDatePart}T${timePart.replace(/ /g, 'T')}`); 
                
                // If the Date constructor fails to handle the time (common issue), try date part only
                if (isNaN(date.getTime())) {
                    date = new Date(isoDatePart); 
                }
                
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
            
            // Fallback for standard ISO or other recognizable formats
            date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;
            
            return null;
        }

        /**
         * UPDATED: Formats date strictly as DD-MM-YYYY.
         */
        function formatDate(dateString) {
            const date = parseDate(dateString);
            if (!date) return 'N/A';
            
            // Use en-GB locale (DD/MM/YYYY) and replace the slash with a dash.
            const datePart = date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).replace(/\//g, '-'); 
            
            return datePart;
        }

        /**
         * Helper function to format date and time for the detailed print report (DD-MM-YYYY HH:MM AM/PM).
         */
        function formatDateTimeForPrint(dateString) {
            const date = parseDate(dateString);
            if (!date) return 'N/A';
            
            // 1. Get DD-MM-YYYY part (using the robust format)
            const datePart = date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).replace(/\//g, '-'); 
            
            // 2. Get HH:MM AM/PM part
            // Note: We use toLocaleTimeString to handle time zone conversion which might be needed
            const timePart = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

            return `${datePart} ${timePart}`;
        }
        // =========================================================================================

        
        function setupFilters() {
            const units = [...new Set(allData.map(d => d.Unit).filter(Boolean))].sort();
            const staff = [...new Set(allData.map(d => d.fieldOfficerName).filter(Boolean))].sort();
            
            ui.unitFilter.innerHTML = '<option value="">सर्व युनिट</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
            ui.staffFilter.innerHTML = '<option value="">सर्व कर्मचारी</option>' + staff.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function setupEventListeners() {
            [ui.customerSearch, ui.unitFilter, ui.staffFilter, ui.dateFrom, ui.dateTo].forEach(el => {
                el.addEventListener('input', applyFiltersAndRender); 
            });
            document.querySelectorAll('.kpi-card.clickable').forEach(card => {
                card.addEventListener('click', () => showStatusApplicantsModal(card.dataset.status));
            });
            ui.modalCloseBtn.onclick = () => ui.modal.style.display = "none";
            window.onclick = (event) => { if (event.target == ui.modal) ui.modal.style.display = "none"; };
        }

        function applyFiltersAndRender() {
            const searchTerm = ui.customerSearch.value.toLowerCase();
            const unit = ui.unitFilter.value;
            const staff = ui.staffFilter.value;
            
            const dateFromStr = ui.dateFrom.value;
            const dateToStr = ui.dateTo.value;

            const dateFrom = dateFromStr ? parseDate(dateFromStr) : null;
            const dateTo = dateToStr ? parseDate(dateToStr) : null;

            if (dateTo) {
                // Ensure the filter includes the entire "To" day
                dateTo.setHours(23, 59, 59, 999);
            }
            if (dateFrom) {
                 // Ensure the filter starts exactly at the beginning of the "From" day
                dateFrom.setHours(0, 0, 0, 0);
            }
            
            filteredData = allData.filter(d => {
                const searchMatch = !searchTerm || (d.customerName && d.customerName.toLowerCase().includes(searchTerm));
                const unitMatch = !unit || d.Unit === unit;
                const staffMatch = !staff || d.fieldOfficerName === staff;
                
                const appDate = d.actualTime ? parseDate(d.actualTime) : null;
                
                const dateMatch = (!dateFrom || (appDate && appDate.getTime() >= dateFrom.getTime())) && 
                                  (!dateTo || (appDate && appDate.getTime() <= dateTo.getTime()));

                return searchMatch && unitMatch && staffMatch && dateMatch;
            });

            updateKPIs();
            renderCharts();
            generateApprovedCustomerInsights(); 
        }

        function updateKPIs() {
            ui.kpi.total.textContent = filteredData.length;
            ui.kpi.pending.textContent = filteredData.filter(d => d.VerificationStatus === 'Pending').length;
            ui.kpi.approved.textContent = filteredData.filter(d => d.VerificationStatus === 'Approved').length;
            ui.kpi.rejected.textContent = filteredData.filter(d => d.VerificationStatus === 'Rejected').length;
        }

        function renderCharts() {
            const chartConfigs = [
                { elementId: 'loanTypeChart', title: 'कर्ज प्रकारानुसार अर्ज', type: 'doughnut', field: 'loanProductType' },
                { elementId: 'talukaChart', title: 'तालुक्यानुसार अर्ज', type: 'bar', field: 'taluka' }
            ];
            
            chartConfigs.forEach(config => {
                if (chartInstances[config.elementId]) {
                    chartInstances[config.elementId].destroy();
                }
                const ctx = document.getElementById(config.elementId)?.getContext('2d');
                if(!ctx) return;

                const dataCounts = filteredData.reduce((acc, item) => {
                    const key = item[config.field] || 'माहिती नाही';
                    acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});
                
                const backgroundColors = ['#0078d4', '#28a745', '#ffb900', '#e81123', '#17a2b8', '#6c757d', '#512da8'];

                chartInstances[config.elementId] = new Chart(ctx, {
                    type: config.type,
                    data: {
                        labels: Object.keys(dataCounts),
                        datasets: [{
                            label: config.title, data: Object.values(dataCounts),
                            backgroundColor: Object.keys(dataCounts).map((_, i) => backgroundColors[i % backgroundColors.length]),
                            borderColor: '#fff', borderWidth: 2
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'bottom' } 
                        },
                        scales: config.type === 'bar' ? { y: { beginAtZero: true } } : {}
                    }
                });
            });
        }
        
        function generateApprovedCustomerInsights() {
            const approvedData = filteredData.filter(d => d.VerificationStatus === 'Approved');
            ui.approvedInsightsContainer.innerHTML = '';
            
            INSIGHT_KPIS.forEach(kpi => {
                const dataSlice = approvedData.filter(kpi.filter);
                const count = dataSlice.length;

                const cardHTML = `
                    <div class="kpi-card clickable insights-card" data-kpi-key="${kpi.key}" data-kpi-label="${kpi.label}">
                        <div class="kpi-icon"><i class="${kpi.icon}"></i></div>
                        <div class="kpi-content">
                            <h3>${count}</h3>
                            <p>${kpi.label}</p>
                        </div>
                    </div>
                `;
                ui.approvedInsightsContainer.innerHTML += cardHTML;
            });
            
            ui.approvedInsightsContainer.querySelectorAll('.clickable').forEach(card => {
                card.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.kpiKey;
                    const label = e.currentTarget.dataset.kpiLabel;
                    showApprovedInsightDetailsModal(key, label);
                });
            });
        }
        
        function showApprovedInsightDetailsModal(kpiKey, label) {
            const approvedData = filteredData.filter(d => d.VerificationStatus === 'Approved');
            const kpiDefinition = INSIGHT_KPIS.find(k => k.key === kpiKey);

            if (!kpiDefinition) return;

            const data = approvedData.filter(kpiDefinition.filter);

            ui.modalTitle.textContent = `${label} (${data.length})`;
            
            const modalTable = document.getElementById('modal-table');
            modalTable.innerHTML = `<thead><tr><th>ग्राहक नाव</th><th>गाव</th><th>मोबाईल नंबर</th><th>कर्ज मागणी (रु)</th></tr></thead><tbody></tbody>`;
            const tbody = modalTable.querySelector('tbody');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">या गटात मंजूर अर्जदार नाहीत.</td></tr>`;
            } else {
                data.forEach(item => {
                    tbody.innerHTML += `<tr>
                        <td>${item.customerName || 'N/A'}</td>
                        <td>${item.villageName || 'N/A'}</td>
                        <td>${item.mobileNumber || 'N/A'}</td>
                        <td>₹ ${parseInt(item.loanAmountRequested || 0).toLocaleString('en-IN')}</td>
                    </tr>`;
                });
            }
            ui.modal.style.display = 'block';
        }


        // Modal for showing status applicants (Total, Pending, Approved, Rejected)
        function showStatusApplicantsModal(status) {
            let data;
            let statusMarathi;
            const allowPrintButton = PRINT_ALLOWED_STATUSES.includes(status);

            if (status === 'Total') {
                data = filteredData;
                statusMarathi = 'एकूण';
            } else if (status === 'Pending') {
                data = filteredData.filter(d => d.VerificationStatus === 'Pending');
                statusMarathi = 'प्रोसेस / प्रलंबित';
            } else {
                data = filteredData.filter(d => d.VerificationStatus === status);
                statusMarathi = status === 'Approved' ? 'मंजूर' : 'नामंजूर';
            }
            
            ui.modalTitle.textContent = `${statusMarathi} अर्जदारांची यादी (${data.length})`;

            const modalTable = document.getElementById('modal-table');
            
            let headerHTML = `<thead><tr><th>ग्राहक</th><th>गाव</th><th>मोबाईल नंबर</th><th>${MARATHI_LABELS.actualTime}</th><th>कर्ज मागणी</th>`;
            if (allowPrintButton) {
                headerHTML += `<th>कृती</th>`;
            }
            headerHTML += `</tr></thead><tbody></tbody>`;
            modalTable.innerHTML = headerHTML;
            const tbody = modalTable.querySelector('tbody');
            const colspanCount = allowPrintButton ? 6 : 5; 

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colspanCount}" style="text-align:center;">या गटात एकही अर्ज नाही.</td></tr>`;
            } else {
                data.forEach(item => {
                    const row = tbody.insertRow();
                    let rowHTML = `
                        <td>${item.customerName || 'N/A'}</td>
                        <td>${item.villageName || 'N/A'}</td>
                        <td>${item.mobileNumber || 'N/A'}</td> 
                        <td>${formatDate(item.actualTime)}</td>
                        <td>₹ ${parseInt(item.loanAmountRequested || 0).toLocaleString('en-IN')}</td>
                    `;
                    if (allowPrintButton) {
                        rowHTML += `<td><button class="print-btn" data-row="${item.row}"><i class="fas fa-print"></i> रिपोर्ट प्रिंट करा</button></td>`;
                    }
                    row.innerHTML = rowHTML;
                });
            }
            
            ui.modal.style.display = "block";
            
            if (allowPrintButton) {
                ui.modal.querySelectorAll('.print-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const rowId = parseInt(e.currentTarget.dataset.row);
                        const applicantData = allData.find(d => d.row === rowId);
                        if (applicantData) printReport(applicantData);
                    });
                });
            }
        }
        
        // --- Print Functions ---
        function printReport(data) {
            if (data) {
                ui.modal.style.display = 'none'; 
                ui.printArea.innerHTML = generatePrintHTML(data);
                
                const images = ui.printArea.querySelectorAll('img');
                const promises = Array.from(images).map(img => new Promise(resolve => {
                    if (img.complete) { resolve(); } 
                    else { img.onload = resolve; img.onerror = resolve; }
                }));
                
                Promise.all(promises).then(() => window.print());
            } else {
                alert("प्रिंट करण्यासाठी डेटा उपलब्ध नाही.");
            }
        }
        
        function generatePrintHTML(data) {
            const logoUrl = "https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png";
            const mapImageUrl = (data.gpsLatitude && data.gpsLongitude) ? `https://static-maps.yandex.ru/1.x/?ll=${data.gpsLongitude},${data.gpsLatitude}&z=17&l=sat,skl&size=650,450&pt=${data.gpsLongitude},${data.gpsLatitude},pm2rdl` : '';
            const gmapLink = (data.gpsLatitude && data.gpsLongitude) ? `https://www.google.com/maps?q=${data.gpsLatitude},${data.gpsLongitude}` : '';
            
            // --- Keys for Basic Info Table (Fixed Structure) ---
            const BASIC_KEYS = [
                'customerName', 'applicantAge', 'applicantGender', 'maritalStatus', 'educationLevel', 
                'mobileNumber', 'aadhaarNumber', 'panNumber', 'villageName', 'taluka', 'district',
                'loanProductType', 'loanAmountRequested', 'ApprovedLoanAmount', 'VerificationStatus', 'actualTime'
            ];

            let detailsHTML = `<div class="print-page">
                <div class="print-watermark">अनिक फायनान्स</div>
                <div class="print-content">
                    <div class="print-header">
                        <img src="${logoUrl}" alt="Company Logo">
                        <h1>GPS व्हेरिफिकेशन अहवाल</h1>
                    </div>
                
                    <h3 class="section-title">अर्जदाराची मूलभूत माहिती</h3>
                    <table class="print-table">`;
            
            // Generate Basic Info Table
            BASIC_KEYS.forEach(key => {
                const value = data[key];
                if (value && String(value).trim() !== '') {
                    let displayValue = value;
                    let labelKey = key; 

                    if (key === 'actualTime') {
                        // Use DD-MM-YYYY HH:MM format for print
                        displayValue = formatDateTimeForPrint(value);
                        labelKey = 'actualTime'; 
                    } 
                    else if (key.includes('Amount') || key.includes('Requested')) {
                         displayValue = `रु ${parseInt(value || 0).toLocaleString('en-IN')}`;
                    }
                    
                    detailsHTML += `<tr><td>${MARATHI_LABELS[labelKey] || key}</td><td>${displayValue}</td></tr>`;
                }
            });

            detailsHTML += `</table>`;
            
            
            // --- Dynamic Remaining Info ---
            
            const EXCLUDED_KEYS = [
                ...BASIC_KEYS, 'timestamp', 'row', 'photoLinks', 'gpsLatitude', 'gpsLongitude', 'gpsAddress', 'googleMapsLink'
            ];
            
            let remainingInfoContent = '';
            
            for (const key in data) {
                if (!EXCLUDED_KEYS.includes(key) && data[key] && String(data[key]).trim() !== '' && data.hasOwnProperty(key)) {
                    const value = data[key];
                    const label = MARATHI_LABELS[key] || key; 
                    
                    let displayValue = value;
                    
                    if (key.includes('Income') || key.includes('expense') || key.includes('Amount')) {
                         const numVal = parseInt(String(value).replace(/,/g, '') || 0);
                         if (!isNaN(numVal) && numVal > 0) {
                            displayValue = `रु ${numVal.toLocaleString('en-IN')}`;
                         }
                    } 
                    else if (key === 'VerificationTimestamp') {
                         // Use DD-MM-YYYY HH:MM format for print
                         displayValue = formatDateTimeForPrint(value);
                    }
                    
                    remainingInfoContent += `<tr><td>${label}</td><td>${displayValue}</td></tr>`;
                }
            }
            
            if(remainingInfoContent) { 
                detailsHTML += `<h3 class="section-title">इतर तपशील व पडताळणी माहिती</h3>
                                <table class="print-table">${remainingInfoContent}</table>`; 
            }

            // --- Geolocation and Map ---
            if (mapImageUrl) { 
                detailsHTML += `<h3 class="section-title">स्थानिक (GPS) पडताळणी</h3>
                    <div class="map-container" style="page-break-inside: avoid;">
                        <p><strong>GPS पत्ता:</strong> ${data.gpsAddress || 'N/A'}</p>
                        <p><strong>Google Maps Link:</strong> <a href="${gmapLink}" target="_blank">${gmapLink}</a></p>
                        <img src="${mapImageUrl}" alt="GPS Location Map">
                    </div>`; 
            }

            // --- Photo Links ---
            if (data.photoLinks && typeof data.photoLinks === 'string' && data.photoLinks.trim() !== '') {
                detailsHTML += `<h3 class="section-title">काढलेले छायाचित्र (लिंक्स)</h3>
                    <div class="photo-grid">`;
                data.photoLinks.split(',').forEach((url, i) => {
                    const trimmedUrl = url.trim();
                    if (trimmedUrl) {
                        detailsHTML += `<div class="print-photo-container">
                                            <p>फोटो ${i+1}</p>
                                            <a href="${trimmedUrl}" target="_blank">${trimmedUrl}</a>
                                        </div>`;
                    }
                });
                detailsHTML += `</div>`;
            }

            
            detailsHTML += `<div class="print-footer">हा रिपोर्ट अनिक फायनान्शियल सर्व्हिसेस, ${new Date().toLocaleDateString('mr-IN')} रोजी स्वयंचलितपणे तयार झाला आहे.</div>
                        </div>
                    </div>`;
            return detailsHTML;
        }

    </script>
</body>
</html>